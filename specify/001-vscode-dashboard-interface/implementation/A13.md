# 实现记录 - A13

## 行动信息
- **编号**: A13
- **描述**: 测试单例模式和资源清理

## 实现细节

### 测试方案

#### 1. 单例模式测试

**测试目标**: 验证同时只能打开一个仪表盘实例

**测试步骤**:
1. 点击侧边栏的仪表盘按钮打开第一个实例
2. 再次点击仪表盘按钮
3. 验证不会创建新的标签页，而是将现有实例移到前台

**预期结果**:
- 只存在一个仪表盘标签页
- 第二次点击时，现有标签页被激活（`panel.reveal()`）

**实现位置**: `dashboard-provider.js:17-23`
```javascript
async openDashboard() {
    // 如果已存在实例，直接显示
    if (this.panel) {
        this.panel.reveal(vscode.ViewColumn.One);
        return;
    }
    // 否则创建新实例
    this.panel = vscode.window.createWebviewPanel(...);
}
```

#### 2. 资源清理测试

**测试目标**: 验证关闭仪表盘时正确清理资源

**测试步骤**:
1. 打开仪表盘
2. 观察文件监视器是否正常工作（修改 `specify/` 目录中的文件，验证自动刷新）
3. 关闭仪表盘标签页
4. 再次打开仪表盘，验证功能正常

**预期结果**:
- 关闭时 `onDidDispose` 事件触发
- `this.panel` 设置为 `null`
- 文件监视器被销毁（`this.watcher.dispose()`）
- 重新打开时功能完全正常

**实现位置**: `dashboard-provider.js:59-66`
```javascript
this.panel.onDidDispose(() => {
    this.panel = null;
    if (this.watcher) {
        this.watcher.dispose();
        this.watcher = null;
    }
    if (this.refreshTimeout) {
        clearTimeout(this.refreshTimeout);
    }
});
```

### 测试验证

#### 单例模式验证点
- ✅ `this.panel` 引用的唯一性
- ✅ `reveal()` 方法的正确调用
- ✅ 不会创建多个 WebviewPanel 实例

#### 资源清理验证点
- ✅ `panel` 引用被正确清空
- ✅ `watcher` 被正确 dispose
- ✅ `refreshTimeout` 被正确清除
- ✅ 订阅已添加到 `context.subscriptions`（自动清理）

### 符合约束

- ✅ 单例模式（符合讨论记录 D02）
- ✅ 资源管理和清理（符合宪法 T08、T09）
- ✅ 订阅管理（符合研究报告的资源管理模式）

---
*创建时间: 2025-09-30*