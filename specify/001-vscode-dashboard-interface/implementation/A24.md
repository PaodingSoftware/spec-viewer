# 实现记录 - A24

## 行动信息
- **编号**: A24
- **描述**: 添加研究完成标识和优化进度条计算

## 实现细节

### 需求背景
用户提出两个优化需求：
1. 单独提供一个图标来标识当前topic是否已经完成了研究，无论是否已完成研究，都要显示标识
2. 进度条要按照主要阶段进行切分，比如new-topic阶段占10%，discuss阶段占30%。这样即使没有到action阶段，也有进度，而不是0%

### 修改的文件

#### 1. `extension/src/utils/senatus-parser.js`

##### 添加 hasResearch 字段
在 `parseTopic()` 方法中添加研究完成标识：

```javascript
// Check if research is completed
const hasResearch = files.has('research.md');
```

返回对象中添加该字段：

```javascript
return {
    sequence,
    name,
    dirName,
    stage: finalStage,
    files: Array.from(files),
    hasResearch: hasResearch,  // 新增字段
    discussionCount: discussData.discussionCount,
    discussions: discussData.discussions,
    taskCount: planData.taskCount,
    completedCount: planData.completedCount,
    completionRate: completionRate,
    tasks: planData.tasks
};
```

##### 添加 calculateCompletionRate() 方法
新增方法，按阶段分配基础进度：

```javascript
/**
 * Calculate completion rate based on stage
 * Stage weights: new-topic(10%), research(20%), discuss(30%), plan(40%), action(40-100% based on tasks)
 * @param {string} stage - Current stage
 * @param {number} taskCount - Total task count
 * @param {number} completedCount - Completed task count
 * @returns {number} Completion rate (0-100)
 */
calculateCompletionRate(stage, taskCount, completedCount) {
    const stageWeights = {
        'new-topic': 10,
        'research': 20,
        'discuss': 30,
        'plan': 40,
        'action': 40,
        'completed': 100
    };

    const baseProgress = stageWeights[stage] || 0;

    // For action and completed stages, calculate task-based progress
    if (stage === 'action' && taskCount > 0) {
        const taskProgress = (completedCount / taskCount) * 60; // 60% weight for tasks (40% to 100%)
        return Math.round(baseProgress + taskProgress);
    } else if (stage === 'completed') {
        return 100;
    }

    return baseProgress;
}
```

**进度计算逻辑**:
- new-topic: 10%（创建主题）
- research: 20%（完成研究）
- discuss: 30%（进行讨论）
- plan: 40%（制定计划）
- action: 40-100%（执行任务，基础40% + 任务完成率×60%）
- completed: 100%（全部完成）

调用该方法：

```javascript
// Calculate completion rate based on stages
const completionRate = this.calculateCompletionRate(finalStage, planData.taskCount, planData.completedCount);
```

#### 2. `extension/webview/dashboard/dashboard.js`

##### 在当前主题卡片中添加研究完成标识
在 `renderCurrentTopicCard()` 函数中，阶段标签之前添加研究标识：

```javascript
// Add research completion indicator
const researchIndicator = document.createElement('span');
researchIndicator.className = `research-indicator ${topic.hasResearch ? 'completed' : 'pending'}`;
researchIndicator.title = topic.hasResearch ? 'Research completed' : 'Research not completed';
researchIndicator.innerHTML = `<i class="fas fa-search"></i>`;

header.appendChild(title);
header.appendChild(researchIndicator);  // 在标题和阶段标签之间
header.appendChild(stageBadge);
```

##### 在主题列表中添加研究完成标识
在 `renderTopicItem()` 函数中，同样添加研究标识：

```javascript
// Add research completion indicator
const researchIndicator = document.createElement('span');
researchIndicator.className = `research-indicator ${topic.hasResearch ? 'completed' : 'pending'}`;
researchIndicator.title = topic.hasResearch ? 'Research completed' : 'Research not completed';
researchIndicator.innerHTML = `<i class="fas fa-search"></i>`;

item.appendChild(sequence);
item.appendChild(info);
item.appendChild(researchIndicator);  // 在信息和阶段标签之间
item.appendChild(stageBadge);
```

**显示逻辑**:
- 已完成研究（hasResearch=true）：添加 `completed` 类，显示绿色背景
- 未完成研究（hasResearch=false）：添加 `pending` 类，显示灰色背景
- 使用搜索图标（fa-search）表示研究状态
- 添加 title 提示文本，鼠标悬停时显示状态说明

#### 3. `extension/webview/dashboard/dashboard.css`

##### 添加研究完成标识样式
在阶段标签样式之后添加：

```css
/* Research Indicator */
.research-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 12px;
    margin-left: auto;
    margin-right: 8px;
    cursor: help;
}

.research-indicator.completed {
    background-color: var(--color-success);
    color: white;
}

.research-indicator.pending {
    background-color: var(--color-neutral-muted);
    color: var(--color-fg-muted);
}
```

**样式说明**:
- 圆形设计（border-radius: 50%）
- 固定尺寸（28px × 28px）
- 居中对齐图标
- 已完成：绿色背景（--color-success），白色图标
- 未完成：灰色背景（--color-neutral-muted），灰色图标
- cursor: help 表示鼠标悬停时显示帮助提示
- margin-left: auto 使其靠右对齐（在 flex 容器中）

### 实现效果

#### 研究完成标识
- ✅ 在当前主题卡片的标题行显示研究标识（标题右侧，阶段标签左侧）
- ✅ 在主题列表的每个主题项显示研究标识（信息右侧，阶段标签左侧）
- ✅ 已完成研究显示绿色圆形图标
- ✅ 未完成研究显示灰色圆形图标
- ✅ 鼠标悬停显示状态提示

#### 进度条优化
- ✅ new-topic 阶段显示 10% 进度
- ✅ research 阶段显示 20% 进度
- ✅ discuss 阶段显示 30% 进度
- ✅ plan 阶段显示 40% 进度
- ✅ action 阶段显示 40-100% 进度（根据任务完成率）
- ✅ completed 阶段显示 100% 进度
- ✅ 早期阶段不再显示 0% 进度

### 符合宪法约束
- ✅ 使用 JavaScript (Node.js) 作为主要开发语言
- ✅ 保持 VSCode Extension API 兼容性
- ✅ 使用清晰的模块划分和命名规范
- ✅ 添加必要的代码注释和函数文档
- ✅ 改善用户体验，提供清晰的视觉反馈

---
*创建时间: 2025-10-10*
