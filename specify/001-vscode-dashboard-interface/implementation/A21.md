# 实现记录 - A21

## 行动信息
- **编号**: A21
- **描述**: 修复仪表盘在讨论阶段不显示内容的问题

## 实现细节

### 问题现象

当主题处于早期阶段（new-topic、research、discuss）时，还没有创建 `plan.md` 文件，因此没有任务（tasks）。在这种情况下，仪表盘的当前主题卡片中不显示任何列表内容，只显示标题、阶段标签和进度条，给用户的感觉是"空白"或"没有内容"。

然而，在讨论阶段，主题通常已经有多条讨论记录（D01, D02, D03...），这些讨论记录是非常有价值的信息，应该展示出来。

### 用户期望

用户希望：
- 当主题有任务时，显示任务列表（已有功能）
- 当主题还没有任务但有讨论记录时，显示讨论列表（缺失功能）
- 无论主题处于哪个阶段，仪表盘都能提供有价值的信息展示

### 根本原因

在 `extension/webview/dashboard/dashboard.js` 的 `renderCurrentTopicCard()` 函数中：

```javascript
// 原代码（第130-132行）
if (topic.tasks && topic.tasks.length > 0) {
    const taskList = renderTaskList(topic.tasks);
    card.appendChild(taskList);
}
// 如果没有任务，则不显示任何列表
```

这段逻辑只在有任务时才渲染列表，没有处理"无任务但有讨论"的情况。

### 解决方案

采用**优先级显示策略**：

1. **优先显示任务列表**（如果存在）- 适用于 plan/action/completed 阶段
2. **其次显示讨论列表**（如果任务不存在但讨论存在）- 适用于 new-topic/research/discuss 阶段
3. **都不存在时不显示列表**（保持原有逻辑）

这样可以确保仪表盘在各个阶段都能展示最相关的信息。

### 修改内容

#### 1. 修改 dashboard.js - 添加讨论列表显示逻辑

**文件**: `extension/webview/dashboard/dashboard.js`

```diff
  card.appendChild(header);
  card.appendChild(progressContainer);

- // Task list if exists
+ // Show task list if exists, otherwise show discussion list
  if (topic.tasks && topic.tasks.length > 0) {
      const taskList = renderTaskList(topic.tasks); // Show all tasks
      card.appendChild(taskList);
+ } else if (topic.discussions && topic.discussions.length > 0) {
+     // When no tasks exist yet (early stage), show discussions instead
+     const discussionList = renderDiscussionList(topic.discussions);
+     card.appendChild(discussionList);
  }

  return card;
```

#### 2. 实现 renderDiscussionList() 函数

**文件**: `extension/webview/dashboard/dashboard.js`

```javascript
/**
 * Render discussion list
 */
function renderDiscussionList(discussions) {
    const list = document.createElement('div');
    list.className = 'discussion-list';

    discussions.forEach(discussion => {
        const item = document.createElement('div');
        item.className = 'discussion-item';

        const icon = document.createElement('i');
        icon.className = 'fas fa-comment discussion-icon';

        const discussionInfo = document.createElement('div');
        discussionInfo.className = 'discussion-info';

        const discussionId = document.createElement('span');
        discussionId.className = 'discussion-id';
        discussionId.textContent = discussion.id;

        const discussionQuestion = document.createElement('span');
        discussionQuestion.className = 'discussion-question';
        discussionQuestion.textContent = discussion.question;

        const discussionTime = document.createElement('span');
        discussionTime.className = 'discussion-time';
        discussionTime.textContent = discussion.timestamp;

        discussionInfo.appendChild(discussionId);
        discussionInfo.appendChild(discussionQuestion);
        discussionInfo.appendChild(discussionTime);

        item.appendChild(icon);
        item.appendChild(discussionInfo);

        list.appendChild(item);
    });

    return list;
}
```

#### 3. 添加讨论列表样式

**文件**: `extension/webview/dashboard/dashboard.css`

```css
/* Discussion List */
.discussion-list {
    margin-top: 16px;
    max-height: 400px;
    overflow-y: auto;
}

.discussion-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--color-border-muted);
}

.discussion-item:last-child {
    border-bottom: none;
}

.discussion-icon {
    font-size: 14px;
    margin-top: 2px;
    color: var(--color-accent);
}

.discussion-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.discussion-id {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--color-fg-muted);
}

.discussion-question {
    font-size: 13px;
    color: var(--color-fg-default);
    line-height: 1.4;
}

.discussion-time {
    font-size: 11px;
    color: var(--color-fg-muted);
    font-family: var(--font-mono);
}
```

#### 4. 添加 fa-comment 图标

**文件**: `extension/assets/fontawesome/fontawesome.css`

```diff
  /* Dashboard Icons */
  .fa-chart-line::before { content: "\f201"; }
  .fa-sync-alt::before { content: "\f2f1"; }
+ .fa-comment::before { content: "\f075"; }
  .fa-comments::before { content: "\f086"; }
  .fa-tasks::before { content: "\f0ae"; }
```

### 数据流

1. **后端解析** (`senatus-parser.js`)：
   - `parseDiscuss()` 方法已经解析了讨论记录
   - 返回 `discussions` 数组，包含 `id`、`timestamp`、`question` 字段

2. **数据传递**：
   - 通过 `DashboardProvider` 传递给前端
   - 包含在 `topic.discussions` 中

3. **前端渲染**：
   - `renderCurrentTopicCard()` 检查 `topic.discussions`
   - 调用 `renderDiscussionList()` 生成 DOM
   - 应用 CSS 样式

### UI 展示效果

讨论列表的展示格式：

```
┌─────────────────────────────────────────┐
│ 💬 D01                                  │
│    创建仪表盘界面的基本设计             │
│    2025-09-30 20:40:01                  │
├─────────────────────────────────────────┤
│ 💬 D02                                  │
│    确定实时更新机制                     │
│    2025-09-30 20:44:47                  │
├─────────────────────────────────────────┤
│ 💬 D03                                  │
│    解析 Senatus 数据结构                │
│    2025-09-30 20:49:28                  │
└─────────────────────────────────────────┘
```

### 阶段与显示内容的对应关系

| 阶段      | tasks 存在 | discussions 存在 | 显示内容     |
| --------- | ---------- | ---------------- | ------------ |
| new-topic | ❌          | ✅                | 讨论列表     |
| research  | ❌          | ✅                | 讨论列表     |
| discuss   | ❌          | ✅                | 讨论列表     |
| plan      | ✅          | ✅                | **任务列表** |
| action    | ✅          | ✅                | **任务列表** |
| completed | ✅          | ✅                | **任务列表** |

任务优先级 > 讨论优先级，确保进入 plan 阶段后，重点展示任务进度。

### 符合宪法约束

- ✅ **用户体验约束**："必须提供清晰的信息展示"
- ✅ **功能约束**："必须在文件变化时自动更新视图"（讨论列表也会随文件变化更新）
- ✅ **代码质量约束**："必须添加必要的代码注释和函数文档"
- ✅ **架构约束**："保持前端资源的自包含性"（使用本地 Font Awesome 图标）

### 测试场景

1. **新建主题测试**：
   - 创建新主题，只有 `discuss.md` 文件，添加几条讨论记录
   - 打开仪表盘，验证显示讨论列表

2. **进度演进测试**：
   - 从讨论阶段逐步创建 `plan.md`
   - 验证显示从讨论列表切换到任务列表

3. **空主题测试**：
   - 创建主题但不添加任何讨论或任务
   - 验证不显示列表（不报错）

4. **多讨论测试**：
   - 添加超过 10 条讨论记录
   - 验证滚动条正常显示（max-height: 400px）

---
*创建时间: 2025-10-10*
