# 实现记录 - T01

## 任务信息
- **编号**: T01
- **描述**: 创建 Senatus 数据解析工具类 `extension/src/utils/senatus-parser.js`

## 实现细节

### 创建的文件
- `extension/src/utils/senatus-parser.js`

### 核心功能实现

#### 1. SenatusParser 类
创建了数据解析工具类，负责扫描和解析 `specify/` 目录：

```javascript
class SenatusParser {
    constructor(workspaceFolder) {
        this.workspaceFolder = workspaceFolder;
        this.specifyPath = path.join(workspaceFolder, 'specify');
    }
}
```

#### 2. 主解析方法 `parseAll()`
返回包含所有主题和当前主题的结构化数据：

```javascript
async parseAll() {
    const topics = await this.scanTopics();
    const currentTopic = this.getCurrentTopic(topics);
    return {
        topics: topics,
        currentTopic: currentTopic,
        hasTopics: topics.length > 0
    };
}
```

#### 3. 主题扫描 `scanTopics()`
- 扫描 `specify/` 目录下所有匹配 `NNN-topic-name` 格式的目录
- 使用正则 `/^\d{3}-/` 匹配目录名
- 按序号排序返回主题列表
- 错误处理：目录不存在时返回空数组

#### 4. 单个主题解析 `parseTopic()`
解析主题目录，提取以下信息：
- **序号和名称**: 从目录名提取
- **文件列表**: 扫描目录中的所有文件
- **进度阶段**: 根据文件存在性判断（`determineStage()`）
- **讨论数据**: 解析 `discuss.md`（`parseDiscuss()`）
- **任务数据**: 解析 `plan.md`（`parsePlan()`）

#### 5. 阶段判断 `determineStage()`
实现流程阶段判断逻辑：
```
new-topic → research → discuss → plan → action
```

判断规则：
- 存在 `implementation/` 目录 → action
- 存在 `plan.md` → plan
- 存在 `discuss.md` + `research.md` → discuss
- 存在 `research.md` → research
- 存在 `discuss.md` → new-topic

#### 6. discuss.md 解析 `parseDiscuss()`
使用正则表达式提取讨论记录：
```javascript
const discussionRegex = /### (D\d+) - (.+?)\n\*\*问题\*\*: (.+?)\n\*\*结论\*\*:/gs;
```

提取信息：
- 讨论编号（D01, D02...）
- 时间戳
- 问题描述

#### 7. plan.md 解析 `parsePlan()`
使用正则表达式提取任务：
```javascript
const taskRegex = /^(A\d+)\. \[(⏳|✅)[^\]]*\] (.+?)$/gm;
```

提取信息：
- 任务编号（T01, T02...）
- 状态（⏳ 待执行 / ✅ 已完成）
- 任务描述
- 统计完成数量和总数

#### 8. 当前主题获取 `getCurrentTopic()`
返回序号最大的主题（列表最后一项）

### 错误处理策略
- 所有文件读取操作使用 try-catch 包裹
- 格式不符的文件忽略，返回默认值
- 目录不存在时返回空数据结构
- 在控制台输出错误日志便于调试

### 使用的技术
- **fs.promises**: 异步文件操作
- **path**: 路径处理
- **marked**: Markdown 解析（已引入但主要用正则）
- **正则表达式**: 提取结构化数据

---
*创建时间: 2025-09-30*