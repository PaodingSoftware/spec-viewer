# 实现记录 - A26

## 行动信息
- **编号**: A26
- **描述**: 将 research 从 stage progression 中移除，使其成为独立属性

## 实现细节

### 需求背景
用户提出：research 应该不属于 stage progression 的一部分，独立出来，new-topic 下一个阶段就是 discuss。

### 问题分析

在之前的实现中，research 被作为一个阶段纳入了 stage progression 流程：
```
new-topic → research → discuss → plan → action → completed
```

但实际上，research（研究）更应该是一个**独立的属性标识**，而不是工作流程中的一个必经阶段。原因如下：

1. **research 是可选的**：不是所有主题都需要进行研究，有些主题可以直接进入讨论
2. **research 不阻塞流程**：即使没有完成研究，也可以进行讨论、计划和执行
3. **research 是辅助信息**：研究文档是为了帮助理解问题，但不是流程的必要步骤
4. **混淆阶段概念**：将 research 作为阶段会让用户误以为必须先完成研究才能讨论

### 正确的设计

**阶段流程**（stage progression）：
```
new-topic → discuss → plan → action → completed
```

**研究标识**（独立属性）：
- `hasResearch`: boolean 字段，标识是否有 research.md 文件
- 在 UI 中显示为独立的徽章（"Researched" / "Not Researched"）
- 不影响阶段判断和流程进度

### 修改的文件

#### 1. `extension/src/utils/senatus-parser.js`

##### 修改 `determineStage()` 方法 - 移除 research 阶段

**原代码**（包含 research 阶段）：
```javascript
determineStage(files, discussionCount = 0) {
    if (files.has('implementation')) {
        return 'action';
    }
    if (files.has('plan.md')) {
        return 'plan';
    }
    // Enter discuss stage when discussion list is not empty
    if (files.has('discuss.md') && discussionCount > 0) {
        return 'discuss';
    }
    if (files.has('research.md')) {
        return 'research';  // ← research 阶段
    }
    if (files.has('discuss.md')) {
        return 'new-topic';
    }
    return 'new-topic';
}
```

**新代码**（移除 research 阶段）：
```javascript
/**
 * Determine topic stage based on existing files and discussion count
 * Stage progression: new-topic → discuss → plan → action → completed
 * Research is independent and tracked separately via hasResearch field
 * @param {Set<string>} files - Set of file names
 * @param {number} discussionCount - Number of discussions in discuss.md
 * @returns {string} Stage name
 */
determineStage(files, discussionCount = 0) {
    // Check implementation directory for action stage
    if (files.has('implementation')) {
        return 'action';
    }
    if (files.has('plan.md')) {
        return 'plan';
    }
    // Enter discuss stage when discussion list is not empty
    if (files.has('discuss.md') && discussionCount > 0) {
        return 'discuss';
    }
    // Default to new-topic stage
    if (files.has('discuss.md')) {
        return 'new-topic';
    }
    return 'new-topic';
}
```

**关键变化**：
1. 删除了 `if (files.has('research.md')) { return 'research'; }` 判断
2. 更新注释，明确说明 research 是独立属性，不是阶段
3. 简化了逻辑，new-topic 后直接进入 discuss（如果有讨论记录）

##### 修改 `calculateCompletionRate()` 方法 - 调整进度权重

**原代码**（包含 research 阶段的 20% 权重）：
```javascript
/**
 * Calculate completion rate based on stage
 * Stage weights: new-topic(10%), research(20%), discuss(30%), plan(40%), action(40-100% based on tasks)
 */
calculateCompletionRate(stage, taskCount, completedCount) {
    const stageWeights = {
        'new-topic': 10,
        'research': 20,  // ← research 占 20%
        'discuss': 30,
        'plan': 40,
        'action': 40,
        'completed': 100
    };

    const baseProgress = stageWeights[stage] || 0;

    if (stage === 'action' && taskCount > 0) {
        const taskProgress = (completedCount / taskCount) * 60; // 60% for tasks
        return Math.round(baseProgress + taskProgress);
    } else if (stage === 'completed') {
        return 100;
    }

    return baseProgress;
}
```

**新代码**（移除 research，重新分配权重）：
```javascript
/**
 * Calculate completion rate based on stage
 * Stage weights: new-topic(10%), discuss(30%), plan(50%), action(50-100% based on tasks)
 * Research is independent and does not affect stage progression
 * @param {string} stage - Current stage
 * @param {number} taskCount - Total task count
 * @param {number} completedCount - Completed task count
 * @returns {number} Completion rate (0-100)
 */
calculateCompletionRate(stage, taskCount, completedCount) {
    const stageWeights = {
        'new-topic': 10,
        'discuss': 30,
        'plan': 50,      // 40% → 50% (+10%)
        'action': 50,    // 40% → 50% (+10%)
        'completed': 100
    };

    const baseProgress = stageWeights[stage] || 0;

    // For action and completed stages, calculate task-based progress
    if (stage === 'action' && taskCount > 0) {
        const taskProgress = (completedCount / taskCount) * 50; // 60% → 50% (50% to 100%)
        return Math.round(baseProgress + taskProgress);
    } else if (stage === 'completed') {
        return 100;
    }

    return baseProgress;
}
```

**权重调整说明**：

移除 research 阶段的 20% 后，将这部分权重重新分配：

| 阶段      | 原权重  | 新权重  | 变化     |
| --------- | ------- | ------- | -------- |
| new-topic | 10%     | 10%     | 不变     |
| research  | 20%     | -       | 移除     |
| discuss   | 30%     | 30%     | 不变     |
| plan      | 40%     | 50%     | +10%     |
| action    | 40-100% | 50-100% | 基础+10% |
| completed | 100%    | 100%    | 不变     |

**调整逻辑**：
- plan 阶段从 40% 提升到 50%（+10%）
- action 阶段基础进度从 40% 提升到 50%（+10%）
- action 阶段的任务完成权重从 60% 调整为 50%（保证总进度仍是 100%）

#### 2. `extension/webview/dashboard/dashboard.js`

##### 移除 research 阶段的图标和名称定义

**原代码**：
```javascript
function getStageIcon(stage) {
    const icons = {
        'new-topic': 'fa-plus-circle',
        'research': 'fa-search',     // ← research 阶段图标
        'discuss': 'fa-comments',
        'plan': 'fa-clipboard-list',
        'action': 'fa-bolt',
        'completed': 'fa-check-circle'
    };
    return icons[stage] || 'fa-circle';
}

function formatStage(stage) {
    const names = {
        'new-topic': 'New Topic',
        'research': 'Research',      // ← research 阶段名称
        'discuss': 'Discussion',
        'plan': 'Planning',
        'action': 'In Action',
        'completed': 'Completed'
    };
    return names[stage] || stage;
}
```

**新代码**：
```javascript
/**
 * Get icon for stage
 */
function getStageIcon(stage) {
    const icons = {
        'new-topic': 'fa-plus-circle',
        'discuss': 'fa-comments',
        'plan': 'fa-clipboard-list',
        'action': 'fa-bolt',
        'completed': 'fa-check-circle'
    };
    return icons[stage] || 'fa-circle';
}

/**
 * Format stage name
 */
function formatStage(stage) {
    const names = {
        'new-topic': 'New Topic',
        'discuss': 'Discussion',
        'plan': 'Planning',
        'action': 'In Action',
        'completed': 'Completed'
    };
    return names[stage] || stage;
}
```

**关键变化**：
- 删除了 `'research': 'fa-search'` 图标映射
- 删除了 `'research': 'Research'` 名称映射
- 保留其他阶段的定义不变

#### 3. `extension/webview/dashboard/dashboard.css`

##### 移除 research 阶段的样式定义

**原代码**：
```css
.stage-badge.stage-new-topic {
    background-color: var(--color-neutral-muted);
    color: var(--color-fg-default);
}

.stage-badge.stage-research {
    background-color: #8250df;  /* ← research 阶段样式 */
}

.stage-badge.stage-discuss {
    background-color: #0969da;
}

.stage-badge.stage-plan {
    background-color: var(--color-warning);
}

.stage-badge.stage-action {
    background-color: var(--color-success);
}

.stage-badge.stage-completed {
    background-color: #1a7f37;
    color: white;
}
```

**新代码**：
```css
.stage-badge.stage-new-topic {
    background-color: var(--color-neutral-muted);
    color: var(--color-fg-default);
}

.stage-badge.stage-discuss {
    background-color: #0969da;
}

.stage-badge.stage-plan {
    background-color: var(--color-warning);
}

.stage-badge.stage-action {
    background-color: var(--color-success);
}

.stage-badge.stage-completed {
    background-color: #1a7f37;
    color: white;
}
```

**关键变化**：
- 删除了 `.stage-badge.stage-research` 样式规则
- 保留其他阶段的样式不变

### 实现效果

#### 阶段流程简化
- ✅ 新的阶段流程：new-topic → discuss → plan → action → completed
- ✅ research 不再作为阶段出现
- ✅ 没有 research.md 文件也可以正常进入 discuss 阶段（只要有讨论记录）
- ✅ 阶段流程更加清晰，符合实际工作流程

#### 进度计算调整
- ✅ new-topic 阶段：10% 进度
- ✅ discuss 阶段：30% 进度
- ✅ plan 阶段：50% 进度（从 40% 提升）
- ✅ action 阶段：50-100% 进度（基础从 40% 提升）
- ✅ completed 阶段：100% 进度
- ✅ 移除了 research 阶段的 20% 权重

#### research 作为独立属性
- ✅ `hasResearch` 字段独立跟踪研究完成状态
- ✅ 研究完成标识以徽章形式显示（"Researched" / "Not Researched"）
- ✅ 研究状态不影响阶段判断
- ✅ 研究状态不影响进度计算

#### 前端清理
- ✅ 移除了 research 阶段的图标定义（fa-search 现在只用于研究标识）
- ✅ 移除了 research 阶段的名称定义
- ✅ 移除了 research 阶段的 CSS 样式（紫色背景 #8250df）
- ✅ 如果数据中出现 research 阶段，会使用默认图标（fa-circle）和原始文本

### 测试验证

#### 测试场景1：新建主题，没有讨论和研究
- 文件：只有 `discuss.md`（空模板）
- 预期阶段：new-topic
- 预期研究标识：Not Researched（灰色）
- 预期进度：10%
- 实际结果：✅ 通过

#### 测试场景2：有讨论但无研究
- 文件：`discuss.md` 有讨论记录，无 `research.md`
- 预期阶段：discuss（不是 research）
- 预期研究标识：Not Researched（灰色）
- 预期进度：30%
- 实际结果：✅ 通过，research 不再阻塞 discuss 阶段

#### 测试场景3：有讨论和研究
- 文件：`discuss.md` 有讨论记录，有 `research.md`
- 预期阶段：discuss
- 预期研究标识：Researched（蓝色）
- 预期进度：30%
- 实际结果：✅ 通过，research 作为独立标识正常显示

#### 测试场景4：plan 阶段进度
- 文件：有 `plan.md`
- 预期阶段：plan
- 预期进度：50%（原来是 40%）
- 实际结果：✅ 通过，进度权重调整正确

#### 测试场景5：action 阶段进度
- 文件：有 `implementation` 目录，10 个任务完成 5 个
- 预期阶段：action
- 预期进度：50% + (5/10 * 50%) = 75%
- 实际结果：✅ 通过，action 阶段进度计算正确

### 符合宪法约束
- ✅ 使用 JavaScript (Node.js) 作为主要开发语言
- ✅ 保持 VSCode Extension API 兼容性
- ✅ 使用清晰的模块划分和命名规范
- ✅ 添加必要的代码注释和函数文档
- ✅ 正确实现阶段流程逻辑
- ✅ 改善用户体验，简化阶段概念
- ✅ 保持代码的可维护性和可读性

### 关键代码变更总结

**变更1：阶段判断逻辑简化**
- 文件：`senatus-parser.js`
- 变更：移除 research 阶段判断
- 影响：new-topic 后直接进入 discuss（如果有讨论）

**变更2：进度权重重新分配**
- 文件：`senatus-parser.js`
- 变更：移除 research 的 20%，plan 和 action 各增加 10%
- 影响：进度分配更合理，总进度仍为 100%

**变更3：前端清理**
- 文件：`dashboard.js`, `dashboard.css`
- 变更：移除 research 阶段的图标、名称和样式
- 影响：UI 更清晰，不会出现 research 阶段徽章

### 设计理念

这次修改体现了一个重要的设计理念：**区分流程阶段和辅助属性**

**流程阶段**（stage progression）：
- 必经的工作流程步骤
- 有明确的先后顺序
- 影响进度计算
- 例如：new-topic → discuss → plan → action → completed

**辅助属性**（auxiliary properties）：
- 可选的补充信息
- 不阻塞流程进展
- 作为独立标识显示
- 例如：hasResearch（是否有研究文档）

将 research 从阶段流程中移除，改为独立属性，使得：
1. **流程更清晰**：阶段流程只包含必要步骤
2. **灵活性更高**：可以选择性地进行研究，不影响其他工作
3. **概念更准确**：research 是辅助资料，不是流程节点
4. **用户体验更好**：不会因为没有研究而"卡"在某个阶段

---
*创建时间: 2025-10-10*
