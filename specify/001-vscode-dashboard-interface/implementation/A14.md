# 实现记录 - A14

## 行动信息
- **编号**: A14
- **描述**: 测试数据解析错误处理

## 实现细节

### 测试方案

#### 1. 文件不存在测试

**测试目标**: 验证处理缺失文件的健壮性

**测试场景**:
- 主题目录中缺少 `discuss.md`
- 主题目录中缺少 `plan.md`
- 主题目录中缺少 `research.md`

**预期行为**:
- 讨论数返回 `0`
- 任务相关字段返回默认值（`0` 任务，`0` 完成）
- 阶段仍能正确判断（基于存在的文件）

**实现位置**: `senatus-parser.js:74-91` (parseDiscuss)
```javascript
async parseDiscuss(discussPath) {
    try {
        const content = await fs.readFile(discussPath, 'utf-8');
        // ... 解析逻辑
    } catch (error) {
        // 文件不存在或读取失败，返回默认值
        return { discussionCount: 0 };
    }
}
```

#### 2. 格式不符预期测试

**测试目标**: 验证处理格式错误的 Markdown 文件

**测试场景**:
- `discuss.md` 中没有 `### D01` 格式的讨论记录
- `plan.md` 中没有 `| A01` 格式的任务行
- `plan.md` 中状态列不是 `⏳` 或 `✅`

**预期行为**:
- 讨论数为 `0`（没有匹配的讨论模式）
- 任务数为 `0`（没有匹配的任务行）
- 完成率为 `0%`
- 不会抛出异常，继续解析其他主题

**实现位置**: `senatus-parser.js:74-129`
```javascript
// parseDiscuss - 正则匹配失败返回空数组
const discussionMatches = [...content.matchAll(/###\s*D(\d+)/g)];
const discussionCount = discussionMatches.length; // 没有匹配则为 0

// parsePlan - 正则匹配失败返回空数组
const actionMatches = [...content.matchAll(/\|\s*A(\d+)\s*\|/g)];
const completedMatches = [...content.matchAll(/\|\s*A\d+\s*\|[^|]*\|[^|]*\|\s*✅已完成/g)];
```

#### 3. 目录名格式错误测试

**测试目标**: 验证处理非标准目录名

**测试场景**:
- 目录名不匹配 `NNN-topic-name` 格式
- 目录名缺少序号前缀
- 目录名包含特殊字符

**预期行为**:
- `sequence` 返回 `'000'`（默认值）
- `name` 返回原始目录名
- 仍会尝试解析目录内容

**实现位置**: `senatus-parser.js:63-72` (parseTopic)
```javascript
const match = dirName.match(/^(\d+)-(.+)$/);
if (match) {
    sequence = match[1].padStart(3, '0');
    name = match[2].replace(/-/g, ' ');
} else {
    // 格式不符，使用默认值
    sequence = '000';
    name = dirName;
}
```

#### 4. 空目录测试

**测试目标**: 验证处理空的 `specify/` 目录

**测试场景**:
- `specify/` 目录不存在
- `specify/` 目录存在但为空
- `specify/` 目录只包含非目录文件

**预期行为**:
- `topics` 返回空数组 `[]`
- `currentTopic` 返回 `null`
- `hasTopics` 返回 `false`
- 前端显示"空状态"提示

**实现位置**: `senatus-parser.js:23-42` (parseAll)
```javascript
async parseAll() {
    const specifyPath = path.join(this.workspaceFolder, 'specify');
    const topics = await this.scanTopics(specifyPath);

    if (topics.length === 0) {
        return {
            topics: [],
            currentTopic: null,
            hasTopics: false
        };
    }
    // ...
}
```

### 测试验证清单

#### 错误处理验证点
- ✅ try-catch 包裹所有文件读取操作
- ✅ 正则匹配失败返回空数组（不会 throw）
- ✅ 目录扫描失败返回空数组
- ✅ 所有函数都有默认返回值

#### 容错性验证点
- ✅ 缺失文件不影响其他主题的解析
- ✅ 格式错误不会导致崩溃
- ✅ 空目录能正确显示空状态
- ✅ 部分数据缺失时仍能渲染界面

### 符合约束

- ✅ 格式不符合预期则忽略（符合讨论记录 D03）
- ✅ 错误处理和容错机制（符合宪法 T10）
- ✅ 不缓存解析结果，每次重新解析（符合讨论记录 D03）

---
*创建时间: 2025-09-30*