# 实现记录 - A15

## 行动信息
- **编号**: A15
- **描述**: 测试主题适配和跨平台兼容性

## 实现细节

### 测试方案

#### 1. 主题适配测试

**测试目标**: 验证在不同 VSCode 主题下的视觉效果

**测试场景**:
1. **Light Theme** (浅色主题)
   - 切换到 VSCode 默认浅色主题
   - 验证背景色、文字颜色、边框颜色是否正确
   - 验证进度条渐变色在浅色背景下的可读性

2. **Dark Theme** (深色主题)
   - 切换到 VSCode 默认深色主题
   - 验证主题变量是否正确应用
   - 验证悬停效果和选中状态的对比度

3. **High Contrast** (高对比度主题)
   - 切换到高对比度主题
   - 验证所有交互元素是否清晰可见
   - 验证边框和分隔线是否足够明显

**主题变量应用**:

**文件**: `extension/webview/dashboard/dashboard.css`

关键 CSS 变量:
```css
:root {
    /* VSCode 原生变量 */
    --background: var(--vscode-sideBar-background);
    --foreground: var(--vscode-foreground);
    --border: var(--vscode-panel-border);
    --hover-bg: var(--vscode-list-hoverBackground);

    /* 自定义变量（从 viewer.css 复用） */
    --color-primary: #007acc;
    --color-success: #4caf50;
    --color-warning: #ff9800;
    --color-error: #f44336;
}
```

**预期结果**:
- 所有颜色自动适配当前主题
- 无需手动切换样式表
- 文字始终清晰可读
- 交互元素高亮明显

#### 2. 跨平台兼容性测试

**测试目标**: 验证在不同操作系统上的功能正确性

##### 2.1 Windows 平台

**测试重点**:
- 路径分隔符处理（`\` vs `/`）
- 文件路径编码（处理中文路径）
- Font Awesome 图标渲染

**关键代码**:
```javascript
// senatus-parser.js - 使用 path.join() 确保跨平台兼容
const discussPath = path.join(topicPath, 'discuss.md');
const planPath = path.join(topicPath, 'plan.md');

// dashboard.js - 前端路径构造
path: path.join('specify', topic.dirName, 'discuss.md')
```

##### 2.2 macOS 平台

**测试重点**:
- 文件系统大小写敏感性（HFS+ 不敏感，APFS 可配置）
- 字体渲染效果
- 滚动条样式（macOS 原生滚动条行为）

##### 2.3 Linux 平台

**测试重点**:
- 文件系统大小写敏感性（严格敏感）
- 权限问题（读取 `specify/` 目录）
- Font Awesome webfonts 加载

#### 3. 路径处理测试

**测试目标**: 验证文件路径的正确处理

**测试场景**:
- 工作区路径包含空格
- 工作区路径包含特殊字符
- 工作区路径包含中文字符
- 主题目录名包含特殊字符

**验证点**:
- ✅ 使用 `path.join()` 而非字符串拼接
- ✅ 使用 `vscode.Uri.file()` 处理文件 URI
- ✅ 使用 `webview.asWebviewUri()` 转换资源路径

**实现位置**:
```javascript
// resource-uri.js:9-11
static _toUri(context, webview, ...pathSegments) {
    return webview.asWebviewUri(
        vscode.Uri.file(path.join(context.extensionPath, 'extension', ...pathSegments))
    );
}
```

#### 4. 文件监视器测试

**测试目标**: 验证文件监视器在不同平台的行为

**测试场景**:
- 创建新的主题目录
- 修改 `discuss.md` 文件
- 删除主题目录
- 重命名主题目录

**平台差异**:
- **Windows**: NTFS 文件系统，监视器事件可能延迟
- **macOS**: APFS/HFS+，FSEvents 性能较好
- **Linux**: inotify 机制，事件数量限制

**实现位置**: `dashboard-provider.js:92-111`
```javascript
setupFileWatcher() {
    const pattern = new vscode.RelativePattern(
        this.workspaceFolder,
        'specify/**/*'
    );
    this.watcher = vscode.workspace.createFileSystemWatcher(pattern);
    // 1000ms 防抖适用于所有平台
}
```

### 测试验证清单

#### 主题适配验证点
- ✅ 使用 `--vscode-*` 变量适配原生主题
- ✅ 自定义颜色变量继承自 viewer.css
- ✅ 进度条渐变色在深浅主题下均可读
- ✅ 悬停效果使用 `--vscode-list-hoverBackground`

#### 跨平台验证点
- ✅ 使用 `path.join()` 而非硬编码路径分隔符
- ✅ 使用 `vscode.Uri.file()` 处理文件路径
- ✅ Font Awesome 使用 webfonts（自托管，无外部依赖）
- ✅ 文件监视器使用 VSCode API（跨平台抽象）

#### 编码和字符处理
- ✅ 文件读取使用 `utf-8` 编码
- ✅ HTML 内容使用 UTF-8 meta 标签
- ✅ 正则表达式支持 Unicode（`\s`、`\d` 等）

### 符合约束

- ✅ 主题适配（符合宪法 U02）
- ✅ 复用 viewer.css 配色方案（符合讨论记录 D04）
- ✅ 使用 VSCode 原生 API 确保跨平台（符合宪法 T01、T08）
- ✅ 自包含资源（Font Awesome webfonts）（符合宪法 T13）

---
*创建时间: 2025-09-30*