# 实现记录 - T25

## 任务信息
- **编号**: T25
- **描述**: 修复阶段判断逻辑和优化研究标识样式

## 实现细节

### 需求背景
用户提出两个纠正需求：
1. 判断是否进入discuss阶段的依据应该是discuss列表是否为空，和research没有关系
2. research的图标不好看，应该和标识当前阶段的图标采用相同的风格，并用文字显示是否研究。颜色也不要用这种绿色，不好看

### 问题分析

#### 问题1：阶段判断逻辑错误
原来的 `determineStage()` 方法判断逻辑：
```javascript
if (files.has('discuss.md') && files.has('research.md')) {
    return 'discuss';
}
```

**问题**：这个判断条件要求同时存在 `discuss.md` 和 `research.md` 文件才能进入 discuss 阶段，但实际上进入 discuss 阶段的标志应该是开始有讨论记录，而不是完成了研究。

**正确逻辑**：应该基于 `discuss.md` 中的讨论列表是否为空来判断，即 `discussionCount > 0` 时才算真正进入了 discuss 阶段。

#### 问题2：研究标识样式不统一
原来的研究标识样式：
```css
.research-indicator {
    width: 28px;
    height: 28px;
    border-radius: 50%;  /* 圆形 */
    /* ... */
}
.research-indicator.completed {
    background-color: var(--color-success);  /* 绿色 */
    color: white;
}
```

**问题**：
- 样式与阶段标签（stage-badge）风格不一致（阶段标签是圆角矩形徽章）
- 只有图标，没有文字说明，不够直观
- 绿色与 success 状态混淆，不够美观

**正确设计**：应该采用与阶段标签相同的徽章样式，包含图标和文字，使用更合适的颜色。

### 修改的文件

#### 1. `extension/src/utils/senatus-parser.js`

##### 修改 `parseTopic()` 方法 - 调整调用顺序
将原来的调用顺序：
```javascript
// 原顺序
const files = await this.getTopicFiles(topicPath);
const stage = this.determineStage(files);  // 先判断阶段
const discussData = files.has('discuss.md')
    ? await this.parseDiscuss(path.join(topicPath, 'discuss.md'))
    : { discussionCount: 0, discussions: [] };  // 后解析讨论
```

修改为：
```javascript
// 新顺序
const files = await this.getTopicFiles(topicPath);

// 先解析 discuss.md
const discussData = files.has('discuss.md')
    ? await this.parseDiscuss(path.join(topicPath, 'discuss.md'))
    : { discussionCount: 0, discussions: [] };

// 解析 plan.md
const planData = files.has('plan.md')
    ? await this.parsePlan(path.join(topicPath, 'plan.md'))
    : { taskCount: 0, completedCount: 0, tasks: [] };

// 基于 discussionCount 判断阶段
const stage = this.determineStage(files, discussData.discussionCount);
```

**调整原因**：需要先解析 `discuss.md` 获取 `discussionCount`，然后才能正确判断阶段。

##### 修改 `determineStage()` 方法签名和逻辑
修改方法签名，添加 `discussionCount` 参数：
```javascript
/**
 * Determine topic stage based on existing files and discussion count
 * Stage progression: new-topic → research → discuss/inspire → plan → action
 * Enter discuss stage when discussion list is not empty (has at least one discussion)
 * @param {Set<string>} files - Set of file names
 * @param {number} discussionCount - Number of discussions in discuss.md
 * @returns {string} Stage name
 */
determineStage(files, discussionCount = 0) {
    // Check implementation directory for action stage
    if (files.has('implementation')) {
        return 'action';
    }
    if (files.has('plan.md')) {
        return 'plan';
    }
    // Enter discuss stage when discussion list is not empty
    if (files.has('discuss.md') && discussionCount > 0) {
        return 'discuss';
    }
    if (files.has('research.md')) {
        return 'research';
    }
    if (files.has('discuss.md')) {
        return 'new-topic';
    }
    return 'new-topic';
}
```

**关键变化**：
1. 添加 `discussionCount` 参数（默认值为 0）
2. 将 discuss 阶段的判断从 `files.has('research.md')` 改为 `discussionCount > 0`
3. 更新注释说明，明确进入 discuss 阶段的条件是"讨论列表不为空"

**阶段判断流程**：
- 有 `implementation` 目录 → action 阶段
- 有 `plan.md` 文件 → plan 阶段
- 有 `discuss.md` 文件且 discussionCount > 0 → discuss 阶段
- 有 `research.md` 文件 → research 阶段
- 有 `discuss.md` 文件但 discussionCount = 0 → new-topic 阶段
- 其他情况 → new-topic 阶段

#### 2. `extension/webview/dashboard/dashboard.css`

##### 修改 `.research-indicator` 样式
从圆形图标改为徽章样式：

```css
/* Research Indicator */
.research-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;  /* 图标和文字间距，与 stage-badge 一致 */
    padding: 4px 10px;  /* 与 stage-badge 一致 */
    border-radius: 12px;  /* 圆角矩形，与 stage-badge 一致 */
    font-size: 12px;  /* 与 stage-badge 一致 */
    font-weight: 500;  /* 与 stage-badge 一致 */
    margin-left: auto;
    margin-right: 8px;
    cursor: help;
}

.research-indicator.completed {
    background-color: #0969da;  /* 蓝色，与 discuss 阶段一致 */
    color: white;
}

.research-indicator.pending {
    background-color: var(--color-neutral-muted);
    color: var(--color-fg-muted);
}
```

**样式变化对比**：
| 属性       | 原样式                     | 新样式                          | 说明                        |
| ---------- | -------------------------- | ------------------------------- | --------------------------- |
| 形状       | 圆形（border-radius: 50%） | 圆角矩形（border-radius: 12px） | 与阶段标签统一              |
| 尺寸       | 固定 28px×28px             | padding: 4px 10px（自适应内容） | 支持文字显示                |
| gap        | 无                         | 6px                             | 图标和文字间距              |
| 已完成颜色 | 绿色（--color-success）    | 蓝色（#0969da）                 | 更美观，与 discuss 阶段一致 |
| 对齐       | justify-content: center    | 默认 flex start                 | 支持左对齐图标和文字        |

#### 3. `extension/webview/dashboard/dashboard.js`

##### 在当前主题卡片中添加研究标识文字
修改 `renderCurrentTopicCard()` 函数中的研究标识渲染逻辑：

```javascript
// Add research completion indicator
const researchIndicator = document.createElement('span');
researchIndicator.className = `research-indicator ${topic.hasResearch ? 'completed' : 'pending'}`;
researchIndicator.title = topic.hasResearch ? 'Research completed' : 'Research not completed';
researchIndicator.innerHTML = `<i class="fas fa-search"></i> ${topic.hasResearch ? 'Researched' : 'Not Researched'}`;
//                                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
//                                                             添加文字显示

header.appendChild(title);
header.appendChild(researchIndicator);
header.appendChild(stageBadge);
```

##### 在主题列表中添加研究标识文字
修改 `renderTopicItem()` 函数中的研究标识渲染逻辑：

```javascript
// Add research completion indicator
const researchIndicator = document.createElement('span');
researchIndicator.className = `research-indicator ${topic.hasResearch ? 'completed' : 'pending'}`;
researchIndicator.title = topic.hasResearch ? 'Research completed' : 'Research not completed';
researchIndicator.innerHTML = `<i class="fas fa-search"></i> ${topic.hasResearch ? 'Researched' : 'Not Researched'}`;
//                                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
//                                                             添加文字显示

item.appendChild(sequence);
item.appendChild(info);
item.appendChild(researchIndicator);
item.appendChild(stageBadge);
```

**文字显示**：
- 已完成研究：`<i class="fas fa-search"></i> Researched`
- 未完成研究：`<i class="fas fa-search"></i> Not Researched`

### 实现效果

#### 阶段判断逻辑修复
- ✅ 进入 discuss 阶段的条件改为"讨论列表不为空"（discussionCount > 0）
- ✅ 不再依赖 research.md 文件是否存在
- ✅ 即使没有完成研究，只要有讨论记录就进入 discuss 阶段
- ✅ 只有 discuss.md 文件但没有讨论记录时，保持在 new-topic 阶段

#### 研究标识样式优化
- ✅ 从圆形图标改为圆角矩形徽章，与阶段标签风格统一
- ✅ 添加文字显示："Researched" / "Not Researched"
- ✅ 已完成研究使用蓝色背景（#0969da），与 discuss 阶段颜色一致
- ✅ 未完成研究使用灰色背景，保持低调
- ✅ 图标和文字组合，更加直观易懂
- ✅ 在当前主题卡片和主题列表中都应用新样式

### 测试验证

#### 测试场景1：无讨论记录的新主题
- 文件：只有 `discuss.md`，内容为空或只有模板
- 预期阶段：new-topic（因为 discussionCount = 0）
- 实际结果：✅ 正确显示 new-topic 阶段

#### 测试场景2：有讨论记录但无研究
- 文件：`discuss.md` 包含至少一条讨论记录，无 `research.md`
- 预期阶段：discuss（因为 discussionCount > 0）
- 实际结果：✅ 正确显示 discuss 阶段，研究标识显示 "Not Researched"（灰色）

#### 测试场景3：有讨论记录和研究
- 文件：`discuss.md` 包含讨论记录，有 `research.md`
- 预期阶段：discuss（因为 discussionCount > 0）
- 预期标识：研究标识显示 "Researched"（蓝色）
- 实际结果：✅ 正确显示 discuss 阶段和研究完成标识

#### 测试场景4：研究标识样式
- 检查点：徽章形状、文字显示、颜色
- 预期：圆角矩形、包含文字、蓝色/灰色
- 实际结果：✅ 样式与阶段标签保持一致

### 符合宪法约束
- ✅ 使用 JavaScript (Node.js) 作为主要开发语言
- ✅ 保持 VSCode Extension API 兼容性
- ✅ 使用清晰的模块划分和命名规范
- ✅ 添加必要的代码注释和函数文档
- ✅ 正确实现阶段判断逻辑
- ✅ 改善用户体验，提供一致的视觉设计
- ✅ 保持代码的可维护性和可读性

### 关键代码变更总结

**变更1：阶段判断逻辑**
- 文件：`senatus-parser.js`
- 变更：`determineStage()` 方法从依赖 research.md 改为依赖 discussionCount
- 影响：正确反映主题进度，符合实际工作流程

**变更2：调用顺序调整**
- 文件：`senatus-parser.js`
- 变更：在调用 `determineStage()` 前先解析 `discuss.md` 获取 discussionCount
- 影响：确保阶段判断有正确的数据依据

**变更3：样式统一**
- 文件：`dashboard.css`
- 变更：研究标识从圆形改为徽章样式，颜色从绿色改为蓝色
- 影响：视觉一致性更好，更美观

**变更4：文字显示**
- 文件：`dashboard.js`（两处）
- 变更：在研究标识中添加 "Researched" / "Not Researched" 文字
- 影响：信息更直观，用户体验更好

---
*创建时间: 2025-10-10*
