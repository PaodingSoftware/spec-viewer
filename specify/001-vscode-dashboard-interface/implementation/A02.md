# 实现记录 - A02

## 行动信息
- **编号**: A02
- **描述**: 创建仪表盘提供者 `extension/src/providers/dashboard-provider.js`

## 实现细节

### 创建的文件
- `extension/src/providers/dashboard-provider.js`

### 核心功能实现

#### 1. DashboardProvider 类
继承 WebviewBase 基类，实现仪表盘功能：

```javascript
class DashboardProvider extends WebviewBase {
    constructor(context, workspaceFolder) {
        super(context);
        this.workspaceFolder = workspaceFolder;
        this.panel = null; // 单例引用
        this.parser = new SenatusParser(workspaceFolder);
        this.watcher = null;
        this.refreshTimeout = null;
    }
}
```

#### 2. 单例模式实现 `openDashboard()`
确保同时只有一个仪表盘实例：

```javascript
async openDashboard() {
    // 如果面板已存在，直接显示
    if (this.panel) {
        this.panel.reveal(vscode.ViewColumn.One);
        return;
    }

    // 创建新面板
    this.panel = vscode.window.createWebviewPanel(
        'senatussDashboard',
        'Senatus Dashboard',
        vscode.ViewColumn.One,
        {
            enableScripts: true,
            retainContextWhenHidden: true,
            localResourceRoots: [...]
        }
    );
}
```

#### 3. WebviewPanel 配置
- **enableScripts**: 允许运行 JavaScript
- **retainContextWhenHidden**: 隐藏时保持上下文
- **localResourceRoots**: 允许访问 extension 目录

#### 4. 自定义图标设置
复用现有的 spec-light.svg 和 spec-dark.svg：

```javascript
this.panel.iconPath = {
    light: vscode.Uri.file(path.join(this.context.extensionPath, 'extension/icons/spec-light.svg')),
    dark: vscode.Uri.file(path.join(this.context.extensionPath, 'extension/icons/spec-dark.svg'))
};
```

#### 5. 消息处理
监听前端消息并处理命令：

```javascript
this.panel.webview.onDidReceiveMessage(
    async (message) => {
        switch (message.command) {
            case 'openFile':
                await vscode.commands.executeCommand('spec-viewer.openFile', message.path);
                break;
            case 'refresh':
                await this.updatePanelContent();
                break;
        }
    },
    null,
    this.context.subscriptions
);
```

#### 6. 内容更新 `updatePanelContent()`
- 使用 SenatusParser 解析数据
- 生成 HTML 内容
- 更新 webview.html
- 错误处理：显示错误页面

```javascript
async updatePanelContent() {
    if (!this.panel) return;
    try {
        const data = await this.parser.parseAll();
        const html = await this.getDashboardHtml(data);
        this.panel.webview.html = html;
    } catch (error) {
        this.panel.webview.html = await this.getErrorHtml(error.message);
    }
}
```

#### 7. HTML 生成 `getDashboardHtml()`
- 加载 dashboard.html 模板
- 获取资源 URI（使用 ResourceUri.getDashboardUris()）
- 将数据序列化为 JSON
- 使用 WebviewUtils.renderTemplate() 渲染模板

#### 8. 资源清理 `cleanupResources()`
- 清理文件监控器（watcher.dispose()）
- 清理防抖定时器（clearTimeout()）
- 在 panel.onDidDispose 时自动调用

#### 9. 生命周期管理
```javascript
this.panel.onDidDispose(
    () => {
        this.cleanupResources();
        this.panel = null; // 重置单例引用
    },
    null,
    this.context.subscriptions
);
```

### 符合的架构约束
- ✅ 继承 WebviewBase 基类（复用模板加载功能）
- ✅ 使用 Provider 模式
- ✅ 正确处理资源清理
- ✅ 订阅到 context.subscriptions
- ✅ 添加代码注释和函数文档
- ✅ 驼峰命名规范

---
*创建时间: 2025-09-30*