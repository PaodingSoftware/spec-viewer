# 实现记录 - A03

## 行动信息
- **编号**: A03
- **描述**: 在 DashboardProvider 中实现文件监控机制

## 实现细节

### 实现位置
在 `extension/src/providers/dashboard-provider.js` 的 DashboardProvider 类中

### 核心功能实现

#### 1. 文件监控设置 `setupFileWatcher()`
在面板创建时自动调用：

```javascript
setupFileWatcher() {
    // 清理现有监控器
    if (this.watcher) {
        this.watcher.dispose();
    }

    // 创建新监控器
    const pattern = new vscode.RelativePattern(this.workspaceFolder, 'specify/**/*');
    this.watcher = vscode.workspace.createFileSystemWatcher(pattern);

    // 设置防抖刷新
    const debouncedRefresh = () => { ... };

    // 监听文件事件
    this.watcher.onDidCreate(debouncedRefresh);
    this.watcher.onDidChange(debouncedRefresh);
    this.watcher.onDidDelete(debouncedRefresh);

    // 订阅到扩展生命周期
    this.context.subscriptions.push(this.watcher);
}
```

#### 2. 监控范围
使用 `RelativePattern` 监控整个 `specify/` 目录：
- 模式：`specify/**/*`
- 递归监控所有子目录和文件
- 包括 `discuss.md`、`plan.md`、`research.md` 等所有文件

#### 3. 防抖机制实现（1000ms）
```javascript
const debouncedRefresh = () => {
    if (this.refreshTimeout) {
        clearTimeout(this.refreshTimeout);
    }
    this.refreshTimeout = setTimeout(() => {
        if (this.panel) {
            this.updatePanelContent();
        }
    }, 1000); // 1秒防抖
};
```

防抖逻辑：
- 接收到文件变化事件时，先清除旧的定时器
- 启动新的 1000ms 定时器
- 1秒内如有新事件，重新计时
- 1秒后没有新事件，执行刷新

#### 4. 监听的事件类型
- **onDidCreate**: 文件或目录创建
- **onDidChange**: 文件内容修改
- **onDidDelete**: 文件或目录删除

所有事件都触发同一个防抖刷新函数

#### 5. 资源清理
在 `cleanupResources()` 方法中：

```javascript
cleanupResources() {
    if (this.watcher) {
        this.watcher.dispose();
        this.watcher = null;
    }
    if (this.refreshTimeout) {
        clearTimeout(this.refreshTimeout);
        this.refreshTimeout = null;
    }
}
```

清理时机：
- 面板关闭时（panel.onDidDispose）
- 创建新监控器前（setupFileWatcher 开始）

#### 6. 生命周期管理
- watcher 订阅到 `context.subscriptions`
- 扩展停用时自动清理
- 面板销毁时手动清理

### 符合的架构约束
- ✅ 使用 vscode.workspace.createFileSystemWatcher API
- ✅ 实现 1000ms 防抖（符合讨论 D02 决策）
- ✅ 监控整个 specify 目录
- ✅ 正确清理资源（watcher 和 timeout）
- ✅ 订阅管理符合规范
- ✅ 满足"必须在文件变化时自动更新视图"宪法约束

---
*创建时间: 2025-09-30*