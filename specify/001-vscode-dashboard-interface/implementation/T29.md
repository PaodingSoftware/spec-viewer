# 实现记录 - T29

## 任务信息
- **编号**: T29
- **描述**: 修复仪表盘交互问题（主题卡片点击限制、研究标识点击、鼠标样式）

## 实现细节

### 问题背景
用户反馈了三个仪表盘交互问题：
1. 当 `discuss.md` 还不存在时（new-topic 阶段），点击主题卡片会跳转到不存在的文件导致错误
2. 点击研究标识应该跳转到研究报告文件（research.md），而不是默认的 discuss.md
3. 鼠标划到研究标识时不应显示问号光标（cursor: help）

### 实现方案

#### 修复1：主题卡片点击限制

**文件**: `extension/webview/dashboard/dashboard.js`

在 `renderTopicItem()` 函数中添加点击限制逻辑：

```javascript
function renderTopicItem(topic, currentTopic) {
    const item = document.createElement('div');
    item.className = 'topic-item';
    if (currentTopic && topic.sequence === currentTopic.sequence) {
        item.classList.add('current');
    }

    // If discuss.md doesn't exist (new-topic stage without discussions), make it non-clickable
    const canClick = topic.discussionCount > 0;
    if (!canClick) {
        item.classList.add('disabled');
    }

    // ... 其他代码 ...

    // Click handler - open discuss.md (only if it has discussions)
    if (canClick) {
        item.addEventListener('click', () => {
            const filePath = `specify/${topic.dirName}/discuss.md`;
            vscode.postMessage({
                command: 'openFile',
                path: filePath
            });
        });
    }

    return item;
}
```

**文件**: `extension/webview/dashboard/dashboard.css`

添加 `.topic-item.disabled` 样式：

```css
.topic-item.disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.topic-item.disabled:hover {
    background-color: transparent;
    border-color: var(--color-border-muted);
    transform: none;
}
```

**效果**：
- 当主题没有讨论记录时（`discussionCount === 0`），卡片添加 `disabled` 类
- 光标变为 `not-allowed`，透明度降低至 60%
- 禁用 hover 效果，不添加点击事件监听器
- 避免跳转到不存在的文件导致错误

#### 修复2：研究标识点击功能

**文件**: `extension/webview/dashboard/dashboard.js`

在 `renderTopicItem()` 函数中添加研究标识点击事件（主题列表）：

```javascript
const researchIndicator = document.createElement('span');
researchIndicator.className = `research-indicator ${topic.hasResearch ? 'completed' : 'pending'}`;
researchIndicator.title = topic.hasResearch ? 'Research completed' : 'Research not completed';
researchIndicator.innerHTML = `<i class="fas fa-search"></i>`;

// Click handler for research indicator - open research.md
if (topic.hasResearch) {
    researchIndicator.addEventListener('click', (e) => {
        e.stopPropagation();
        const filePath = `specify/${topic.dirName}/research.md`;
        vscode.postMessage({
            command: 'openFile',
            path: filePath
        });
    });
    researchIndicator.style.cursor = 'pointer';
}
```

在 `renderCurrentTopicCard()` 函数中添加研究标识点击事件（当前主题卡片）：

```javascript
// Add research completion indicator
const researchIndicator = document.createElement('span');
researchIndicator.className = `research-indicator ${topic.hasResearch ? 'completed' : 'pending'}`;
researchIndicator.title = topic.hasResearch ? 'Research completed' : 'Research not completed';
researchIndicator.innerHTML = `<i class="fas fa-search"></i> ${topic.hasResearch ? 'Researched' : 'Not Researched'}`;

// Click handler for research indicator - open research.md
if (topic.hasResearch) {
    researchIndicator.addEventListener('click', () => {
        const filePath = `specify/${topic.dirName}/research.md`;
        vscode.postMessage({
            command: 'openFile',
            path: filePath
        });
    });
    researchIndicator.style.cursor = 'pointer';
}
```

**效果**：
- 点击研究标识时，发送 `openFile` 消息，跳转到 `specify/{topic.dirName}/research.md`
- 只有当 `hasResearch === true` 时才添加点击事件和设置光标为 pointer
- 使用 `e.stopPropagation()` 防止事件冒泡到父元素的点击事件（主题列表项）
- 两处实现：当前主题卡片和主题列表

#### 修复3：研究标识鼠标样式

**文件**: `extension/webview/dashboard/dashboard.css`

移除 `cursor: help` 样式：

```css
.research-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin-left: auto;
    margin-right: 6px;
    /* 移除了 cursor: help; */
}

.research-indicator.completed {
    background-color: #8250df;
    color: white;
}

.research-indicator.pending {
    background-color: var(--color-neutral-muted);
    color: var(--color-fg-muted);
}
```

**效果**：
- 默认情况下不显示问号光标
- 当 `hasResearch === true` 时，通过 JavaScript 动态设置 `cursor: pointer`
- 当 `hasResearch === false` 时，使用默认光标（不可点击）

### 技术要点

1. **条件渲染**：根据 `discussionCount` 判断是否添加点击事件
2. **事件冒泡控制**：使用 `e.stopPropagation()` 防止研究标识点击触发父元素事件
3. **动态样式设置**：通过 JavaScript 动态设置 `cursor` 样式，而非在 CSS 中全局定义
4. **用户体验优化**：
   - 禁用状态的主题卡片视觉反馈清晰（降低透明度、更改光标）
   - 可点击元素有明确的光标提示（pointer）
   - 不可点击元素不会误导用户（not-allowed 或 default）

### 测试验证

1. **主题卡片点击限制**：
   - ✅ new-topic 阶段且无讨论记录时，卡片不可点击
   - ✅ 卡片显示 disabled 样式（透明度降低）
   - ✅ 光标显示为 not-allowed
   - ✅ hover 效果被禁用

2. **研究标识点击功能**：
   - ✅ 点击已完成研究的标识，正确跳转到 research.md
   - ✅ 点击事件不会冒泡到主题卡片
   - ✅ 未完成研究的标识不可点击
   - ✅ 当前主题卡片和主题列表的研究标识都正常工作

3. **鼠标样式**：
   - ✅ 已完成研究的标识显示 pointer 光标
   - ✅ 未完成研究的标识显示默认光标
   - ✅ 不再显示问号光标（help）

### 相关文件

修改的文件：
- `extension/webview/dashboard/dashboard.js` - 添加点击限制逻辑和研究标识点击事件
- `extension/webview/dashboard/dashboard.css` - 添加 disabled 样式，移除 cursor: help

### 符合宪法约束

- ✅ 必须提供清晰的错误提示信息（禁用不可用的交互）
- ✅ 必须在文件变化时自动更新视图（现有机制保持不变）
- ✅ 必须使用清晰的模块划分（遵循现有结构）
- ✅ 必须处理异步操作的错误情况（避免跳转到不存在的文件）

---
*创建时间: 2025-10-10*
