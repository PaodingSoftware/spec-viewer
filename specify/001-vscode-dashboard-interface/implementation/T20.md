# 实现记录 - T20

## 任务信息
- **编号**: T20
- **描述**: 修复仪表盘按钮位置不生效问题（使用 navigation@N 排序）

## 实现细节

### 问题现象

在 T19 中调整了 `package.json` 中 `menus.view/title` 数组的顺序，将按钮从：
```json
[dashboard, refresh, collapseAll]
```

调整为：
```json
[refresh, collapseAll, dashboard]
```

但是实际运行时，仪表盘按钮仍然显示在中间位置，而不是预期的最右侧。

### 根本原因

经过研究 VSCode Extension API 文档发现：

**VSCode 的菜单系统中，同一个 `group` 内的多个菜单项的排序，不是由 JSON 数组的顺序决定的，而是由 `group` 属性中的排序数字决定的。**

具体规则：
- 使用格式：`"group": "groupName@sortOrder"`
- `@` 符号后面的数字控制排序
- 数字越小，显示位置越靠前
- 如果不指定数字，VSCode 会使用默认排序（不可预测）

### 错误配置（T19）

```json
{
  "command": "spec-viewer.refresh",
  "when": "view == specViewerExplorer",
  "group": "navigation"  // ❌ 没有指定排序数字
}
```

这种配置下，即使调整 JSON 数组顺序，VSCode 也不会按照预期排序。

### 正确配置（T20）

```json
"menus": {
  "view/title": [
    {
      "command": "spec-viewer.refresh",
      "when": "view == specViewerExplorer",
      "group": "navigation@1"  // ✅ 最左侧（第一个）
    },
    {
      "command": "spec-viewer.collapseAll",
      "when": "view == specViewerExplorer",
      "group": "navigation@2"  // ✅ 中间（第二个）
    },
    {
      "command": "spec-viewer.openDashboard",
      "when": "view == specViewerExplorer",
      "group": "navigation@3"  // ✅ 最右侧（第三个）
    }
  ]
}
```

### 排序逻辑

| 按钮          | group 值       | 排序数字 | 显示位置 |
| ------------- | -------------- | -------- | -------- |
| refresh       | `navigation@1` | 1        | 最左     |
| collapseAll   | `navigation@2` | 2        | 中间     |
| openDashboard | `navigation@3` | 3        | 最右     |

数字越小 → 位置越靠前（左）
数字越大 → 位置越靠后（右）

### VSCode 文档参考

根据 VSCode Extension API 文档中的示例：

```json
{
  "contributes": {
    "menus": {
      "scm/title": [
        {
          "submenu": "git.commit",
          "group": "2_main@1",  // 使用 @1 指定排序
          "when": "scmProvider == git"
        }
      ]
    }
  }
}
```

这个示例展示了使用 `@` 符号后跟数字来控制菜单项排序的标准做法。

### 修改文件

**package.json** - 更新三个按钮的 group 属性：

```diff
  "menus": {
    "view/title": [
      {
        "command": "spec-viewer.refresh",
        "when": "view == specViewerExplorer",
-       "group": "navigation"
+       "group": "navigation@1"
      },
      {
        "command": "spec-viewer.collapseAll",
        "when": "view == specViewerExplorer",
-       "group": "navigation"
+       "group": "navigation@2"
      },
      {
        "command": "spec-viewer.openDashboard",
        "when": "view == specViewerExplorer",
-       "group": "navigation"
+       "group": "navigation@3"
      }
    ]
  }
```

### 测试验证

修改完成后需要：
1. 重新加载 VSCode 扩展（Developer: Reload Window）
2. 打开侧边栏查看按钮位置
3. 确认顺序为：刷新 → 折叠 → 仪表盘（从左到右）

### 经验教训

1. **VSCode 菜单排序机制**：不要假设 JSON 数组顺序会影响显示顺序，必须使用 `@` 符号明确指定
2. **查阅官方文档**：遇到问题时应该查阅 VSCode Extension API 文档和示例
3. **测试验证**：每次修改后都要重新加载扩展进行验证

### 符合宪法约束

- ✅ 正确使用 VSCode Extension API 的菜单贡献点配置
- ✅ 遵循 VSCode 官方文档的最佳实践
- ✅ 保持代码的可维护性和可读性
- ✅ 提供清晰的注释说明排序规则

---
*创建时间: 2025-10-10*
