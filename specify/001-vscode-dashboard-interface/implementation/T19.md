# 实现记录 - T19

## 任务信息
- **编号**: T19
- **描述**: 修复仪表盘图标位置和任务完成状态显示

## 实现细节

本次纠正解决了两个问题：

### 问题1：仪表盘图标位置不正确

**现象**: 仪表盘图标显示在三个图标的最左侧，不符合用户预期。

**期望**: 仪表盘图标应该放在最右侧（refresh → collapseAll → dashboard）

**修复方案**:
在 `package.json` 的 `contributes.menus.view/title` 中调整按钮顺序：

```json
"view/title": [
  {
    "command": "spec-viewer.refresh",
    "when": "view == specViewerExplorer",
    "group": "navigation"
  },
  {
    "command": "spec-viewer.collapseAll",
    "when": "view == specViewerExplorer",
    "group": "navigation"
  },
  {
    "command": "spec-viewer.openDashboard",
    "when": "view == specViewerExplorer",
    "group": "navigation"
  }
]
```

**原顺序**: dashboard → refresh → collapseAll
**新顺序**: refresh → collapseAll → dashboard

### 问题2：缺少任务完成状态

**现象**: 当 plan.md 中的所有任务都完成后，主题状态仍然显示为 "In Action"，没有变更为完成状态。

**期望**: 当所有任务都标记为 ✅ 已完成时，状态应该自动转变为 "Completed"，表示该主题的所有计划已经执行完毕，可以进行纠正操作。

**修复方案**:

#### 1. 更新 `senatus-parser.js` 添加完成状态检测

在 `parseTopic` 方法中添加逻辑，检测所有任务是否完成：

```javascript
// Parse plan.md if exists
const planData = files.has('plan.md')
    ? await this.parsePlan(path.join(topicPath, 'plan.md'))
    : { taskCount: 0, completedCount: 0, tasks: [] };

// Update stage to 'completed' if all tasks are done
let finalStage = stage;
if (stage === 'action' && planData.taskCount > 0 && planData.taskCount === planData.completedCount) {
    finalStage = 'completed';
}

return {
    sequence,
    name,
    dirName,
    stage: finalStage,  // 使用更新后的阶段
    // ... 其他字段
};
```

**检测逻辑**:
- 仅在 `stage === 'action'` 时检测（只有 action 阶段才会转变为 completed）
- 必须有任务存在（`planData.taskCount > 0`）
- 所有任务都已完成（`planData.taskCount === planData.completedCount`）
- 满足条件时将阶段设置为 `'completed'`

#### 2. 更新 `dashboard.js` 支持 completed 阶段

添加 'completed' 阶段的图标和显示名称：

```javascript
function getStageIcon(stage) {
    const icons = {
        'new-topic': 'fa-plus-circle',
        'research': 'fa-search',
        'discuss': 'fa-comments',
        'plan': 'fa-clipboard-list',
        'action': 'fa-bolt',
        'completed': 'fa-check-circle'  // 新增
    };
    return icons[stage] || 'fa-circle';
}

function formatStage(stage) {
    const names = {
        'new-topic': 'New Topic',
        'research': 'Research',
        'discuss': 'Discussion',
        'plan': 'Planning',
        'action': 'In Action',
        'completed': 'Completed'  // 新增
    };
    return names[stage] || stage;
}
```

#### 3. 更新 `dashboard.css` 添加 completed 阶段样式

添加绿色背景样式：

```css
.stage-badge.stage-completed { 
    background-color: #1a7f37; 
    color: white; 
}
```

### 修改文件清单

1. **package.json** - 调整菜单按钮顺序
2. **extension/src/utils/senatus-parser.js** - 添加完成状态检测逻辑
3. **extension/webview/dashboard/dashboard.js** - 添加 completed 阶段支持
4. **extension/webview/dashboard/dashboard.css** - 添加 completed 阶段样式

### 符合宪法约束

- ✅ 使用清晰的模块划分，修改限定在相关模块中
- ✅ 保持代码质量，添加必要的注释
- ✅ 正确处理状态流转逻辑
- ✅ 保持用户体验的一致性
- ✅ 遵循现有的命名规范和代码风格

---
*创建时间: 2025-10-10*
