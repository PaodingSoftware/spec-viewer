# 实现记录 - T05

## 任务信息
- **编号**: T05
- **描述**: 在 dashboard.js 中实现自定义右键菜单，在当前主题卡片上右键时显示"删除研究报告"和"回滚到讨论阶段"选项（根据阶段和文件存在性动态显示）

## 实现细节

### 修改的文件
- `extension/webview/dashboard/dashboard.js`

### 代码变更

#### 1. 添加全局变量
```javascript
let contextMenu = null;
```

#### 2. 在 setupEventListeners 中添加关闭菜单事件
```javascript
// Close context menu on click outside
document.addEventListener('click', () => {
    closeContextMenu();
});
```

#### 3. 在 renderCurrentTopicCard 中添加右键菜单处理
```javascript
// Add context menu handler
card.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    e.stopPropagation();
    showContextMenu(e.clientX, e.clientY, topic);
});
```

#### 4. 实现 showContextMenu 函数
```javascript
function showContextMenu(x, y, topic) {
    closeContextMenu();

    contextMenu = document.createElement('div');
    contextMenu.className = 'context-menu';

    // Delete research option (only if research exists)
    if (topic.hasResearch) {
        const deleteResearchItem = document.createElement('div');
        deleteResearchItem.className = 'context-menu-item danger';
        deleteResearchItem.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Research Report';
        deleteResearchItem.addEventListener('click', (e) => {
            e.stopPropagation();
            vscode.postMessage({
                command: 'deleteResearch',
                topicDirName: topic.dirName
            });
            closeContextMenu();
        });
        contextMenu.appendChild(deleteResearchItem);
    }

    // Rollback to discuss option (only if in plan, action, or completed stage)
    const allowedStages = ['plan', 'action', 'completed'];
    if (allowedStages.includes(topic.stage)) {
        // Add separator if we have previous items
        if (topic.hasResearch) {
            const separator = document.createElement('div');
            separator.className = 'context-menu-separator';
            contextMenu.appendChild(separator);
        }

        const rollbackItem = document.createElement('div');
        rollbackItem.className = 'context-menu-item';
        rollbackItem.innerHTML = '<i class="fas fa-undo"></i> Rollback to Discussion';
        rollbackItem.addEventListener('click', (e) => {
            e.stopPropagation();
            vscode.postMessage({
                command: 'rollbackToDiscuss',
                topicDirName: topic.dirName
            });
            closeContextMenu();
        });
        contextMenu.appendChild(rollbackItem);
    }

    // Only show menu if there are items
    if (contextMenu.children.length > 0) {
        document.body.appendChild(contextMenu);

        // Position the menu
        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';

        // Adjust if menu goes off screen
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            contextMenu.style.left = (x - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            contextMenu.style.top = (y - rect.height) + 'px';
        }
    }
}
```

#### 5. 实现 closeContextMenu 函数
```javascript
function closeContextMenu() {
    if (contextMenu) {
        contextMenu.remove();
        contextMenu = null;
    }
}
```

### 技术要点
1. **动态菜单**: 根据主题状态和文件存在性动态显示菜单项
2. **条件显示**: 研究报告选项仅在 `hasResearch === true` 时显示
3. **阶段检查**: 回滚选项仅在 plan、action、completed 阶段显示
4. **智能定位**: 自动调整菜单位置防止超出屏幕边界
5. **事件隔离**: 使用 `stopPropagation()` 防止事件冒泡
6. **自动关闭**: 点击文档任意位置关闭菜单

---
*创建时间: 2025-10-11*
