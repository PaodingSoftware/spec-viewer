# 实现记录 - A04

## 行动信息
- **编号**: A04
- **描述**: 在 DashboardProvider 中实现回滚到讨论阶段功能（rollbackToDiscuss），删除 plan.md 和 implementation/ 目录，仅在当前主题处于 plan、action 或 completed 阶段时允许回滚

## 实现细节

### 修改的文件
- `extension/src/providers/dashboard-provider.js`

### 代码变更

#### 实现 rollbackToDiscuss 方法
```javascript
async rollbackToDiscuss(topicDirName) {
    try {
        // Validate path
        const topicPath = this.validateTopicPath(topicDirName);
        
        // Get current topic to verify it's the latest
        const data = await this.parser.parseAll();
        if (!data.currentTopic || data.currentTopic.dirName !== topicDirName) {
            vscode.window.showWarningMessage('Only the current topic can be rolled back.');
            return;
        }
        
        // Check if topic is in a stage that allows rollback
        const allowedStages = ['plan', 'action', 'completed'];
        if (!allowedStages.includes(data.currentTopic.stage)) {
            vscode.window.showWarningMessage(`Cannot rollback from ${data.currentTopic.stage} stage.`);
            return;
        }
        
        // Confirm rollback
        const choice = await vscode.window.showWarningMessage(
            'Rollback to discussion stage?\n\nThis will delete:\n• plan.md (action plan)\n• implementation/ directory (all implementation records)\n\nDiscussion records and research report will be preserved.\n\nThis action cannot be undone.',
            { modal: true },
            'Rollback',
            'Cancel'
        );
        
        if (choice !== 'Rollback') {
            return;
        }
        
        // Delete plan.md if exists
        const planPath = path.join(topicPath, 'plan.md');
        try {
            await fs.unlink(planPath);
        } catch (error) {
            // File may not exist, continue
        }
        
        // Delete implementation directory if exists
        const implPath = path.join(topicPath, 'implementation');
        try {
            await fs.rm(implPath, { recursive: true, force: true });
        } catch (error) {
            // Directory may not exist, continue
        }
        
        vscode.window.showInformationMessage('Rolled back to discussion stage successfully');
        
        // Refresh dashboard
        await this.updatePanelContent();
    } catch (error) {
        console.error('Error rolling back:', error);
        vscode.window.showErrorMessage(`Failed to rollback: ${error.message}`);
    }
}
```

### 技术要点
1. **阶段验证**: 只允许从 plan、action、completed 阶段回滚
2. **当前主题检查**: 只允许回滚当前主题
3. **清晰的确认提示**: 详细说明将删除的内容和保留的内容
4. **容错删除**: 使用 try-catch 处理文件/目录不存在的情况
5. **完整回滚**: 同时删除 plan.md 和 implementation/ 目录
6. **保留数据**: 保留 discuss.md 和 research.md（如果存在）

---
*创建时间: 2025-10-11*
