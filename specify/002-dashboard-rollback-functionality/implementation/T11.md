# 实现记录 - T11

## 任务信息
- **编号**: T11
- **描述**: 修复 UI 显示问题：将删除主题功能移到右键菜单中，修复菜单图标显示问题，使用 DOM 元素创建而非 innerHTML，新增 createContextMenuItem 辅助函数

## 实现细节

### 问题分析
1. **删除主题按钮位置不当**：独立的删除按钮显示在卡片右上角，与右键菜单功能重复
2. **图标不显示**：右键菜单项使用 `innerHTML` 直接插入 HTML 字符串，导致 Font Awesome 图标无法正确渲染

### 修改的文件
- `extension/webview/dashboard/dashboard.js`
- `extension/webview/dashboard/dashboard.css`

### 代码变更

#### 1. 移除独立的删除主题按钮（dashboard.js）
```javascript
// 删除以下代码：
// Add delete topic button
const deleteBtn = document.createElement('button');
deleteBtn.className = 'delete-topic-btn';
deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
deleteBtn.title = 'Delete Topic';
deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    vscode.postMessage({
        command: 'deleteTopic',
        topicDirName: topic.dirName
    });
});
card.appendChild(deleteBtn);
```

#### 2. 新增辅助函数 createContextMenuItem
```javascript
/**
 * Create context menu item
 */
function createContextMenuItem(iconClass, text, className, onClick) {
    const item = document.createElement('div');
    item.className = 'context-menu-item';
    if (className) {
        item.classList.add(className);
    }

    const icon = document.createElement('i');
    icon.className = `fas ${iconClass}`;

    const label = document.createElement('span');
    label.textContent = text;

    item.appendChild(icon);
    item.appendChild(label);

    item.addEventListener('click', (e) => {
        e.stopPropagation();
        onClick();
    });

    return item;
}
```

#### 3. 重构 showContextMenu 函数
```javascript
function showContextMenu(x, y, topic) {
    closeContextMenu();

    contextMenu = document.createElement('div');
    contextMenu.className = 'context-menu';

    // Delete topic option (第一项)
    const deleteTopicItem = createContextMenuItem(
        'fa-trash-alt',
        'Delete Topic',
        'danger',
        () => {
            vscode.postMessage({
                command: 'deleteTopic',
                topicDirName: topic.dirName
            });
            closeContextMenu();
        }
    );
    contextMenu.appendChild(deleteTopicItem);

    // Delete research option (仅当研究存在时显示)
    if (topic.hasResearch) {
        const separator = document.createElement('div');
        separator.className = 'context-menu-separator';
        contextMenu.appendChild(separator);

        const deleteResearchItem = createContextMenuItem(
            'fa-trash-alt',
            'Delete Research Report',
            'danger',
            () => {
                vscode.postMessage({
                    command: 'deleteResearch',
                    topicDirName: topic.dirName
                });
                closeContextMenu();
            }
        );
        contextMenu.appendChild(deleteResearchItem);
    }

    // Rollback option (仅在特定阶段显示)
    const allowedStages = ['plan', 'action', 'completed'];
    if (allowedStages.includes(topic.stage)) {
        const separator = document.createElement('div');
        separator.className = 'context-menu-separator';
        contextMenu.appendChild(separator);

        const rollbackItem = createContextMenuItem(
            'fa-undo',
            'Rollback to Discussion',
            '',
            () => {
                vscode.postMessage({
                    command: 'rollbackToDiscuss',
                    topicDirName: topic.dirName
                });
                closeContextMenu();
            }
        );
        contextMenu.appendChild(rollbackItem);
    }

    // 显示菜单并定位
    if (contextMenu.children.length > 0) {
        document.body.appendChild(contextMenu);
        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';

        // 防止超出屏幕边界
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            contextMenu.style.left = (x - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            contextMenu.style.top = (y - rect.height) + 'px';
        }
    }
}
```

#### 4. 移除 CSS 样式（dashboard.css）
```css
/* 删除以下样式 */
.current-topic-card {
    position: relative;  /* 移除 */
}

.delete-topic-btn {  /* 整个规则删除 */
    position: absolute;
    top: 16px;
    right: 16px;
    ...
}
```

### 技术要点

1. **DOM 元素创建**：使用 `document.createElement()` 分别创建图标和文本元素，而非 `innerHTML`
2. **图标渲染**：通过设置 `className` 为 `fas ${iconClass}` 让 Font Awesome 正确应用图标样式
3. **代码复用**：`createContextMenuItem()` 函数统一处理菜单项创建，减少重复代码
4. **菜单结构**：
   - 删除主题（始终显示）
   - 分隔线 + 删除研究（条件显示）
   - 分隔线 + 回滚到讨论（条件显示）
5. **样式一致性**：danger 类应用于删除操作，普通样式应用于回滚操作

### 修复效果
- ✅ 右键菜单图标正确显示
- ✅ 删除主题统一在右键菜单中操作
- ✅ UI 更简洁，减少视觉干扰
- ✅ 代码更易维护

---
*创建时间: 2025-10-11*
