# 实现记录 - A03

## 行动信息
- **编号**: A03
- **描述**: 在 DashboardProvider 中实现删除讨论记录功能（deleteDiscussion），解析 discuss.md 内容删除指定记录，重新编号后续讨论（保持 D01, D02... 连续），使用 fs.writeFile() 写回文件

## 实现细节

### 修改的文件
- `extension/src/providers/dashboard-provider.js`

### 代码变更

#### 实现 deleteDiscussion 方法
```javascript
async deleteDiscussion(topicDirName, discussionId) {
    try {
        // Validate path
        const topicPath = this.validateTopicPath(topicDirName);
        const discussPath = path.join(topicPath, 'discuss.md');
        
        // Get current topic to verify it's the latest
        const data = await this.parser.parseAll();
        if (!data.currentTopic || data.currentTopic.dirName !== topicDirName) {
            vscode.window.showWarningMessage('Only current topic discussions can be deleted.');
            return;
        }
        
        // Read discuss.md
        let content = await fs.readFile(discussPath, 'utf8');
        
        // Extract the discussion number
        const discussionMatch = discussionId.match(/D(\d+)/);
        if (!discussionMatch) {
            throw new Error('Invalid discussion ID format');
        }
        const discussionNum = parseInt(discussionMatch[1], 10);
        
        // Find and remove the specific discussion record
        const recordRegex = new RegExp(
            `### ${discussionId} - [^\\n]+\\n[\\s\\S]*?(?=(?:### D\\d+|---\\n\\*创建时间:))`,
            'g'
        );
        
        const originalContent = content;
        content = content.replace(recordRegex, '');
        
        if (content === originalContent) {
            vscode.window.showWarningMessage('Discussion record not found.');
            return;
        }
        
        // Renumber subsequent discussions
        const discussionRegex = /### (D\d+) - ([^\n]+)\n/g;
        let match;
        const discussions = [];
        
        while ((match = discussionRegex.exec(content)) !== null) {
            const id = match[1];
            const num = parseInt(id.substring(1), 10);
            discussions.push({ id, num, fullMatch: match[0] });
        }
        
        // Renumber discussions that come after the deleted one
        discussions.sort((a, b) => a.num - b.num);
        let expectedNum = 1;
        
        for (const discussion of discussions) {
            if (discussion.num !== expectedNum) {
                const oldId = discussion.id;
                const newId = `D${String(expectedNum).padStart(2, '0')}`;
                
                // Replace all occurrences of the old ID with new ID
                const globalRegex = new RegExp(`### ${oldId} `, 'g');
                content = content.replace(globalRegex, `### ${newId} `);
            }
            expectedNum++;
        }
        
        // Write back to file
        await fs.writeFile(discussPath, content, 'utf8');
        
        vscode.window.showInformationMessage('Discussion deleted and renumbered successfully');
        
        // Refresh dashboard
        await this.updatePanelContent();
    } catch (error) {
        console.error('Error deleting discussion:', error);
        vscode.window.showErrorMessage(`Failed to delete discussion: ${error.message}`);
    }
}
```

### 技术要点
1. **正则表达式删除**: 使用正则表达式匹配并删除指定讨论记录
2. **内容解析**: 提取所有剩余讨论记录的 ID 和序号
3. **自动重编号**: 确保删除后讨论编号保持 D01, D02, D03... 连续
4. **全局替换**: 使用全局正则表达式替换所有出现的讨论 ID
5. **内容完整性**: 保留文件的其他部分（标题、创建时间等）
6. **错误处理**: 检查讨论是否存在，防止无效删除

---
*创建时间: 2025-10-11*
