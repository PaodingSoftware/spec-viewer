# 实现记录 - T19

## 任务信息
- **编号**: T19
- **描述**: 修复删除讨论时可能误删注释的问题：在删除操作前提取并保存所有 HTML 注释块，在无注释的内容上执行删除，最后恢复注释到原位置，确保 discuss.md 顶部的示例注释和其他注释内容不会被误删

## 实现细节

### 问题背景

在 `discuss.md` 文件中，"讨论记录"部分的顶部包含一段 HTML 注释，用于说明讨论记录的格式：

```markdown
## 讨论记录
<!--
每次讨论记录格式：
### D01 - YYYY-MM-DD HH:MM:SS
**问题**: [讨论的具体问题]
**结论**: [达成的结论或决策]

编号格式: D01, D02, D03...（D = Discussion）
-->

### D01 - 2025-10-11 13:16:20
**问题**: ...
```

当前的 `deleteDiscussion()` 方法使用正则表达式 `### D\d+ -` 来匹配和删除讨论记录。虽然理论上正则模式只会匹配实际的讨论记录（不在注释中），但为了确保绝对安全，需要显式地保护注释块，避免在边界情况下误删。

### 设计方案

采用**三步处理策略**：

1. **提取注释**：使用正则 `/<!--[\s\S]*?-->/g` 提取所有 HTML 注释块并保存到数组
2. **替换为占位符**：将所有注释替换为唯一占位符 `<!--COMMENT_PLACEHOLDER-->`
3. **执行删除**：在无注释的内容上执行讨论删除操作
4. **恢复注释**：将所有占位符替换回原始注释内容

### 代码变更

#### 文件：`extension/src/providers/dashboard-provider.js`

**变更位置**：`deleteDiscussion()` 方法中读取文件后的处理逻辑

**修改前**：
```javascript
// Read discuss.md
let content = await fs.readFile(discussPath, 'utf8');

// Extract the discussion number
const discussionMatch = discussionId.match(/D(\d+)/);
if (!discussionMatch) {
    throw new Error('Invalid discussion ID format');
}

// Find and remove the specific discussion record
// Pattern matches from ### D## to the next ### D## or the separator line
const recordRegex = new RegExp(
    `### ${discussionId} - [^\\n]+\\n[\\s\\S]*?(?=(?:### D\\d+|\\n---\\n\\*创建时间:))`,
    'g'
);

const originalContent = content;
content = content.replace(recordRegex, '');

if (content === originalContent) {
    vscode.window.showWarningMessage('Discussion record not found.');
    return;
}

// Write back to file without renumbering
await fs.writeFile(discussPath, content, 'utf8');
```

**修改后**：
```javascript
// Read discuss.md
let content = await fs.readFile(discussPath, 'utf8');

// Extract the discussion number
const discussionMatch = discussionId.match(/D(\d+)/);
if (!discussionMatch) {
    throw new Error('Invalid discussion ID format');
}

// Extract and preserve comment blocks to avoid deleting example discussions
const commentRegex = /<!--[\s\S]*?-->/g;
const comments = content.match(commentRegex) || [];
const contentWithoutComments = content.replace(commentRegex, '<!--COMMENT_PLACEHOLDER-->');

// Find and remove the specific discussion record (only from non-comment content)
// Pattern matches from ### D## to the next ### D## or the separator line
const recordRegex = new RegExp(
    `### ${discussionId} - [^\\n]+\\n[\\s\\S]*?(?=(?:### D\\d+|\\n---\\n\\*创建时间:))`,
    'g'
);

const originalContent = contentWithoutComments;
let modifiedContent = contentWithoutComments.replace(recordRegex, '');

if (modifiedContent === originalContent) {
    vscode.window.showWarningMessage('Discussion record not found.');
    return;
}

// Restore comment blocks
let commentIndex = 0;
content = modifiedContent.replace(/<!--COMMENT_PLACEHOLDER-->/g, () => {
    return comments[commentIndex++] || '';
});

// Write back to file without renumbering
await fs.writeFile(discussPath, content, 'utf8');
```

### 技术细节

#### 注释提取正则
```javascript
const commentRegex = /<!--[\s\S]*?-->/g;
```
- `<!--` 和 `-->` 匹配 HTML 注释的开始和结束标记
- `[\s\S]*?` 非贪婪匹配任意字符（包括换行符）
- `/g` 全局标志，匹配所有注释块

#### 占位符替换
```javascript
const contentWithoutComments = content.replace(commentRegex, '<!--COMMENT_PLACEHOLDER-->');
```
- 使用统一的占位符字符串，确保后续恢复时一一对应
- 占位符本身也是合法的 HTML 注释格式，不会破坏文档结构

#### 注释恢复
```javascript
let commentIndex = 0;
content = modifiedContent.replace(/<!--COMMENT_PLACEHOLDER-->/g, () => {
    return comments[commentIndex++] || '';
});
```
- 使用回调函数按顺序恢复注释
- 计数器 `commentIndex` 确保每个占位符对应正确的原始注释
- `|| ''` 提供默认值，防止数组越界

### 保护范围

此方法保护所有 `<!-- ... -->` 格式的 HTML 注释，包括：
- 讨论记录部分顶部的格式说明注释
- 文件中可能存在的其他任何注释内容
- 未来可能添加的新注释

### 测试场景

#### 场景1：删除实际讨论，注释保留
- **初始状态**：文件包含示例注释和 D01, D02, D03 三条讨论
- **操作**：删除 D02
- **预期结果**：
  - 示例注释完整保留
  - D02 被删除
  - D01 和 D03 保留且编号不变

#### 场景2：多个注释块都保留
- **初始状态**：文件包含多个注释块（顶部示例 + 其他说明）
- **操作**：删除任意讨论
- **预期结果**：所有注释块都完整保留，位置不变

#### 场景3：删除后文件结构正确
- **初始状态**：正常的 discuss.md 文件
- **操作**：删除某个讨论
- **验证**：
  - 文件可以被 Markdown 解析器正确解析
  - SenatusParser 可以正确解析剩余讨论
  - 仪表盘显示正常

### 性能影响

- **时间复杂度**：增加了两次额外的正则替换操作（提取注释 + 恢复注释），但对于 discuss.md 这种小文件（通常几十 KB），影响微乎其微
- **空间复杂度**：需要临时存储注释数组，通常只有 1-2 个注释块，占用内存很小
- **用户体验**：操作仍然是瞬间完成，用户无感知

### 副作用和限制

- **无负面影响**：只是增加了注释提取和恢复的开销，完全向后兼容
- **注释格式要求**：假设注释使用标准 HTML 格式 `<!-- ... -->`，不支持其他非标准格式
- **占位符唯一性**：假设原文不会包含 `<!--COMMENT_PLACEHOLDER-->` 字符串（这是合理的假设）

### 相关讨论记录

- **D01**: 初始设计讨论删除功能
- **D03**: 讨论删除后重新编号（后被 D11 废弃）
- **D07-D10**: 重新编号的多次尝试和修复
- **D11**: 决定移除重新编号功能
- **D12**: **提出保护注释的需求**

---
*创建时间: 2025-10-11*
