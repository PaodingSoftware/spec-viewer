# 实现记录 - A01

## 行动信息
- **编号**: A01
- **描述**: 在 DashboardProvider 中实现删除当前主题功能（deleteTopic），使用 fs.rm() 递归删除整个主题目录，添加模态确认对话框，操作后自动刷新仪表盘

## 实现细节

### 修改的文件
- `extension/src/providers/dashboard-provider.js`

### 代码变更

#### 1. 添加 fs.promises 导入
```javascript
const fs = require('fs').promises;
```

#### 2. 实现 validateTopicPath 方法
添加路径验证方法，确保操作安全：
- 验证路径在 specify/ 目录内
- 防止删除 constitution.md
- 返回验证后的绝对路径

```javascript
validateTopicPath(topicDirName) {
    const specifyPath = path.join(this.workspaceFolder, 'specify');
    const topicPath = path.resolve(specifyPath, topicDirName);
    
    if (!topicPath.startsWith(specifyPath)) {
        throw new Error('Invalid path: must be within specify directory');
    }
    
    const constitutionPath = path.join(specifyPath, 'constitution.md');
    if (topicPath === constitutionPath) {
        throw new Error('Cannot delete constitution.md');
    }
    
    return topicPath;
}
```

#### 3. 实现 deleteTopic 方法
```javascript
async deleteTopic(topicDirName) {
    try {
        // Validate path
        const topicPath = this.validateTopicPath(topicDirName);
        
        // Get current topic to verify it's the latest
        const data = await this.parser.parseAll();
        if (!data.currentTopic || data.currentTopic.dirName !== topicDirName) {
            vscode.window.showWarningMessage('Only the current topic can be deleted.');
            return;
        }
        
        // Confirm deletion with modal dialog
        const choice = await vscode.window.showWarningMessage(
            `Delete topic "${data.currentTopic.name}"?\n\nThis will permanently delete the entire topic directory and cannot be undone.`,
            { modal: true },
            'Delete',
            'Cancel'
        );
        
        if (choice !== 'Delete') {
            return;
        }
        
        // Delete the topic directory recursively
        await fs.rm(topicPath, { recursive: true, force: true });
        
        vscode.window.showInformationMessage('Topic deleted successfully');
        
        // Refresh dashboard
        await this.updatePanelContent();
    } catch (error) {
        console.error('Error deleting topic:', error);
        vscode.window.showErrorMessage(`Failed to delete topic: ${error.message}`);
    }
}
```

### 技术要点
1. **安全验证**: 使用 `path.resolve()` 和字符串比较防止路径遍历攻击
2. **当前主题检查**: 只允许删除当前主题（最新序号）
3. **模态确认**: 使用 `{ modal: true }` 强制用户确认
4. **递归删除**: 使用 `fs.rm()` 配合 `recursive: true` 选项
5. **错误处理**: try-catch 捕获异常并显示友好错误消息
6. **自动刷新**: 删除后调用 `updatePanelContent()` 更新仪表盘

---
*创建时间: 2025-10-11*
