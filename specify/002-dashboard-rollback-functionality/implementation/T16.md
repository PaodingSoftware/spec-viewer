# 实现记录 - T16

## 任务信息
- **编号**: T16
- **描述**: 简化讨论重新编号逻辑：移除复杂的两阶段替换策略，改为简单的从上到下顺序替换，利用 String.replace() 只替换第一个匹配项的特性，从上到下处理时每次替换的正好是目标讨论标题，代码更简洁易懂

## 实现细节

### 问题分析

D08 中实现的两阶段替换策略存在问题：
- 使用 `content.replace(oldHeader, placeholder)` 只替换第一个匹配项
- 使用 `content.replace(placeholder, newHeader)` 也只替换第一个匹配项
- 如果临时占位符不够唯一或者替换过程中产生冲突，会导致某些讨论被漏掉（如 D02）

实际上，重新编号的逻辑非常简单，不需要复杂的两阶段替换。

### 解决方案

简化后的逻辑：
1. 提取所有剩余的讨论记录
2. 按照它们在文件中的位置排序（从上到下）
3. 从上到下遍历，将每个讨论的标题替换为新编号

**关键点**：由于 `String.replace()` 只替换第一个匹配项，而我们是从上到下处理的，每次替换的第一个匹配项正好就是当前要处理的那个讨论标题，不会产生冲突。

### 代码变更

**文件**: `extension/src/providers/dashboard-provider.js`

**变更前**（复杂的两阶段替换）:
```javascript
// Build replacement map: old ID -> new ID
const replacements = [];
for (let i = 0; i < discussions.length; i++) {
    const newNum = i + 1;
    const newId = `D${String(newNum).padStart(2, '0')}`;

    if (discussions[i].id !== newId) {
        replacements.push({
            oldId: discussions[i].id,
            newId: newId
        });
    }
}

// Use a temporary placeholder to avoid conflicts during replacement
// First pass: replace all old IDs with unique placeholders
for (let i = 0; i < replacements.length; i++) {
    const placeholder = `###TEMP_${i}###`;
    const oldHeader = `### ${replacements[i].oldId} -`;
    content = content.replace(oldHeader, placeholder);
}

// Second pass: replace placeholders with new IDs
for (let i = 0; i < replacements.length; i++) {
    const placeholder = `###TEMP_${i}###`;
    const newHeader = `### ${replacements[i].newId} -`;
    content = content.replace(placeholder, newHeader);
}
```

**变更后**（简单的顺序替换）:
```javascript
// Renumber all discussions sequentially from D01
// Simply iterate from top to bottom and replace each header
for (let i = 0; i < discussions.length; i++) {
    const newNum = i + 1;
    const newId = `D${String(newNum).padStart(2, '0')}`;
    
    if (discussions[i].id !== newId) {
        // Replace the old header with the new one
        const oldHeader = `### ${discussions[i].id} -`;
        const newHeader = `### ${newId} -`;
        content = content.replace(oldHeader, newHeader);
    }
}
```

### 为什么简化后的方案能够正确工作

假设删除 D02 后，剩余讨论为：D01, D03, D04, D05, D06

1. 讨论按文件位置排序：`[D01, D03, D04, D05, D06]`
2. 遍历处理：
   - i=0: D01 → D01（无需替换）
   - i=1: D03 → D02，替换 `### D03 -` 为 `### D02 -`（文件中第一个 D03）
   - i=2: D04 → D03，替换 `### D04 -` 为 `### D03 -`（文件中第一个 D04）
   - i=3: D05 → D04，替换 `### D05 -` 为 `### D04 -`（文件中第一个 D05）
   - i=4: D06 → D05，替换 `### D06 -` 为 `### D05 -`（文件中第一个 D06）

每次替换时，由于是从上到下处理，`replace()` 替换的第一个匹配项正好就是我们要处理的那个讨论的标题，不会与其他讨论冲突。

### 优势

1. **代码简洁**：移除了临时占位符、替换映射表等复杂逻辑
2. **易于理解**：逻辑直观，从上到下顺序替换
3. **性能更好**：只需一次遍历，而不是两次
4. **可维护性强**：代码行数减少，逻辑清晰

---
*创建时间: 2025-10-11*
