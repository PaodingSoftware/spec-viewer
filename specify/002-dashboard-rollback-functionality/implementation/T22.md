# 实现记录 - T22

## 任务信息
- **编号**: T22
- **描述**: 移除删除讨论功能：完全移除 deleteDiscussion 相关代码（后端方法、消息处理器、前端按钮、CSS样式），简化代码避免复杂的文件解析和替换逻辑，保留其他回滚功能（删除主题、删除研究报告、回滚到讨论阶段）

## 实现细节

### 背景
删除讨论功能在实现过程中遇到了多个技术问题（D07-D14）：
- 重新编号逻辑复杂（替换冲突、漏替换）
- 注释保护问题
- 正则表达式边界情况（行首匹配、分隔线匹配）
- 维护成本高

用户要求移除此功能以简化代码。

### 代码变更

#### 1. 后端代码变更 - dashboard-provider.js

**移除消息处理器中的 deleteDiscussion case**:
```javascript
// 移除前
case 'deleteDiscussion':
    await this.deleteDiscussion(message.topicDirName, message.discussionId);
    break;

// 移除后（直接删除该 case）
```

**移除整个 deleteDiscussion 方法** (约 86 行代码):
```javascript
// 完全移除此方法（第 347-432 行）
async deleteDiscussion(topicDirName, discussionId) {
    // ... 完整的方法实现
}
```

此方法包含了复杂的逻辑：
- 路径验证
- 当前主题验证
- 模态确认对话框
- HTML 注释提取和保护
- 正则表达式匹配和替换（带多行模式和行首锚点）
- 注释恢复
- 文件写回
- 错误处理

#### 2. 前端代码变更 - dashboard.js

**移除讨论列表项的删除按钮** (约 16 行代码):
```javascript
// 移除前
// Add delete button
const deleteBtn = document.createElement('button');
deleteBtn.className = 'delete-item-btn';
deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
deleteBtn.title = 'Delete Discussion';
deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    vscode.postMessage({
        command: 'deleteDiscussion',
        topicDirName: dashboardData.currentTopic.dirName,
        discussionId: discussion.id
    });
});

item.appendChild(icon);
item.appendChild(discussionInfo);
item.appendChild(deleteBtn);  // 删除此行

// 移除后
item.appendChild(icon);
item.appendChild(discussionInfo);
// 不再添加 deleteBtn
```

#### 3. 样式变更 - dashboard.css

**移除 hover 显示样式**:
```css
/* 移除 */
.discussion-item:hover .delete-item-btn {
    opacity: 1;
}
```

**移除按钮样式定义** (约 24 行代码):
```css
/* Delete Item Button (for discussions) */
.delete-item-btn {
    position: absolute;
    right: 4px;
    top: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border: none;
    border-radius: 3px;
    background-color: transparent;
    color: #6a737d;
    cursor: pointer;
    transition: opacity 0.2s, background-color 0.2s, color 0.2s;
    font-size: 12px;
    opacity: 0;
    pointer-events: auto;
}

.delete-item-btn:hover {
    background-color: #dc3545;
    color: white;
}

.delete-item-btn:active {
    transform: scale(0.95);
}
```

### 保留的功能
以下回滚功能保持不变：
1. **删除主题** (`deleteTopic`) - 删除整个主题目录
2. **删除研究报告** (`deleteResearch`) - 删除 research.md 文件
3. **回滚到讨论阶段** (`rollbackToDiscuss`) - 删除 plan.md 和 implementation/ 目录

### 用户替代方案
用户仍然可以通过以下方式管理讨论：
1. 直接编辑 `specify/{topic}/discuss.md` 文件
2. 使用"回滚到讨论阶段"功能重新开始
3. 使用"删除主题"功能删除整个主题重新创建

### 测试
移除后应验证：
- 仪表盘正常加载
- 讨论列表正常显示（无删除按钮）
- 其他回滚功能正常工作
- 无 JavaScript 错误

### 代码统计
移除的代码行数：
- JavaScript (backend): ~89 行
- JavaScript (frontend): ~16 行
- CSS: ~28 行
- **总计**: ~133 行代码

---
*创建时间: 2025-10-11*
