# 实现记录 - A10

## 行动信息
- **编号**: A10
- **描述**: 实现路径验证机制，确保所有文件操作严格限制在 specify/ 目录内，使用 path.join() 和 path.resolve() 防止路径遍历攻击，禁止删除 constitution.md

## 实现细节

### 修改的文件
- `extension/src/providers/dashboard-provider.js`

### 代码变更

#### validateTopicPath 方法
```javascript
/**
 * Validate path is within specify directory
 * @param {string} topicDirName - Topic directory name
 * @returns {string} Validated absolute path
 */
validateTopicPath(topicDirName) {
    const specifyPath = path.join(this.workspaceFolder, 'specify');
    const topicPath = path.resolve(specifyPath, topicDirName);
    
    // Ensure path is within specify directory
    if (!topicPath.startsWith(specifyPath)) {
        throw new Error('Invalid path: must be within specify directory');
    }
    
    // Prevent deletion of constitution.md
    const constitutionPath = path.join(specifyPath, 'constitution.md');
    if (topicPath === constitutionPath) {
        throw new Error('Cannot delete constitution.md');
    }
    
    return topicPath;
}
```

### 安全机制

#### 1. 路径规范化
- 使用 `path.join()` 构建基础路径
- 使用 `path.resolve()` 解析和规范化目标路径
- 确保处理 `..`、`.` 等特殊路径组件

#### 2. 路径遍历防护
```javascript
if (!topicPath.startsWith(specifyPath)) {
    throw new Error('Invalid path: must be within specify directory');
}
```
- 检查解析后的路径是否以 specify 目录开头
- 防止 `../../sensitive-file` 等路径遍历攻击

#### 3. 宪法文件保护
```javascript
const constitutionPath = path.join(specifyPath, 'constitution.md');
if (topicPath === constitutionPath) {
    throw new Error('Cannot delete constitution.md');
}
```
- 明确禁止删除 `constitution.md`
- 保护项目约束定义文件

#### 4. 使用位置
所有涉及文件操作的方法都调用此验证：
- `deleteTopic()`: 验证主题目录路径
- `deleteResearch()`: 验证主题目录路径，构建 research.md 路径
- `deleteDiscussion()`: 验证主题目录路径，构建 discuss.md 路径
- `rollbackToDiscuss()`: 验证主题目录路径

### 技术要点
1. **防御性编程**: 所有用户输入都经过验证
2. **路径规范化**: 处理各种路径表示形式
3. **白名单机制**: 只允许 specify/ 目录内的操作
4. **错误提示**: 抛出明确的错误信息
5. **集中验证**: 单一方法处理所有路径验证，便于维护
6. **跨平台兼容**: 使用 Node.js path 模块处理不同操作系统的路径

---
*创建时间: 2025-10-11*
