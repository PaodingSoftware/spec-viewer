# 实现记录 - T19

## 任务信息
- **编号**: T19
- **描述**: 修复模板渲染缺失 URI 变量导致的样式丢失问题

## 实现细节

### 问题分析
用户报告页面样式全都不对了。经过检查发现,在 T06-T09 重构中:
1. 创建了共享 CSS 变量文件 `extension/webview/shared/variables.css`
2. 在 HTML 模板中添加了 `{{sharedVariablesUri}}` 占位符
3. viewer.html 还添加了 `{{sharedUtilsUri}}` 占位符
4. 在 ResourceUri 类中添加了对应的 URI 生成方法

但是,**在 Provider 的模板渲染代码中忘记传递这些新增的变量**,导致占位符未被替换,浏览器无法加载 CSS 变量文件,页面样式全部丢失。

### 修改的文件

#### 1. dashboard-provider.js
在 `getDashboardHtml()` 方法中添加 `sharedVariablesUri`:

**修改前**:
```javascript
return WebviewUtils.renderTemplate(template, {
    fontAwesomeUri: uris.fontAwesome,
    styleUri: uris.style,
    scriptUri: uris.script,
    dataJson: dataJson
});
```

**修改后**:
```javascript
return WebviewUtils.renderTemplate(template, {
    fontAwesomeUri: uris.fontAwesome,
    sharedVariablesUri: uris.sharedVariables,
    styleUri: uris.style,
    scriptUri: uris.script,
    dataJson: dataJson
});
```

#### 2. file-viewer-provider.js
在 `getMarkdownWebviewContent()` 方法中添加 `sharedVariablesUri` 和 `sharedUtilsUri`:

**修改前**:
```javascript
return WebviewUtils.renderTemplate(htmlTemplate, {
    fontAwesomeUri: uris.fontAwesome,
    styleUri: uris.style,
    highlightThemeUri: uris.highlightTheme,
    highlightJsUri: uris.highlightJs,
    scriptUri: uris.script,
    viewMode: viewMode,
    rawContentJson: JSON.stringify(rawContent),
    previewDisplay: viewMode === 'preview' ? 'block' : 'none',
    sourceDisplay: viewMode === 'source' ? 'block' : 'none',
    htmlContent: htmlContent,
    rawContent: WebviewUtils.escapeHtml(rawContent)
});
```

**修改后**:
```javascript
return WebviewUtils.renderTemplate(htmlTemplate, {
    fontAwesomeUri: uris.fontAwesome,
    sharedVariablesUri: uris.sharedVariables,
    styleUri: uris.style,
    highlightThemeUri: uris.highlightTheme,
    highlightJsUri: uris.highlightJs,
    sharedUtilsUri: uris.sharedUtils,
    scriptUri: uris.script,
    viewMode: viewMode,
    rawContentJson: JSON.stringify(rawContent),
    previewDisplay: viewMode === 'preview' ? 'block' : 'none',
    sourceDisplay: viewMode === 'source' ? 'block' : 'none',
    htmlContent: htmlContent,
    rawContent: WebviewUtils.escapeHtml(rawContent)
});
```

#### 3. sidebar-provider.js
在 `getHtmlContent()` 方法中添加 `sharedVariablesUri`:

**修改前**:
```javascript
return WebviewUtils.renderTemplate(template, {
    fontAwesomeUri: uris.fontAwesome,
    styleUri: uris.style,
    fileIconsUri: uris.fileIcons,
    scriptUri: uris.script
});
```

**修改后**:
```javascript
return WebviewUtils.renderTemplate(template, {
    fontAwesomeUri: uris.fontAwesome,
    sharedVariablesUri: uris.sharedVariables,
    styleUri: uris.style,
    fileIconsUri: uris.fileIcons,
    scriptUri: uris.script
});
```

### 问题原因
这是典型的**"修改了接口但忘记更新调用方"**的问题：
- 修改了 HTML 模板(添加了新的占位符)
- 修改了资源 URI 生成(ResourceUri 类添加了新字段)
- **但忘记修改使用这些模板的代码**(Provider 的渲染方法)

### 教训
在进行重构时,需要全面检查变更的影响范围:
1. 修改了模板 → 需要检查所有使用该模板的代码
2. 添加了新的占位符 → 需要确保所有渲染调用都提供了对应的值
3. 建议在 D12 制定重构范围时,应该明确列出"需要同步更新的调用代码"

### 验证方法
1. 重新加载 VSCode 窗口
2. 打开 Dashboard、Sidebar、Viewer
3. 确认页面样式正常显示
4. 确认深色/浅色主题切换正常

---
*创建时间: 2025-10-11*
